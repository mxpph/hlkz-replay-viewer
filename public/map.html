<!DOCTYPE html>
<html data-theme="dark">

<head>
    <title>HLKZ Replay Viewer</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/pico.min.css">
    <link rel="stylesheet" href="css/map.css">
    <link rel="stylesheet" href="css/hlviewer.js.css">
    <script type="module" src="hlviewer.min.js"></script>
    <script defer>
        let viewer;

        const params = new URLSearchParams(window.location.search);
        const mapName = params.get("map");
        const mapNameRegex = /^[a-zA-Z0-9_\-\[\]]+$/;
        if (!mapName || !mapNameRegex.test(mapName)) {
            document.body.innerHTML = `
            <main class='container'>
                <h1>Error</h1>
                <p>Invalid or missing map name.</p>
                <a href='/'>Go Home</a>
            </main>`;
            throw new Error("Invalid map name");
        }
        document.title = `HLKZ Replay Viewer - ${mapName}`

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("title").innerText = mapName;

            viewer = HLViewer.init('#player-container', {
                paths: {
                    base: '/resources/',
                    replays: '/resources/replays',
                    maps: '/resources/maps',
                    wads: '/resources/',
                    skies: '/resources/gfx/env',
                    sounds: '/resources/sound'
                }
            });

            fetch(`https://hlkz.sourceruns.org/api/maps/${mapName}/pure`)
                .then(r => r.json())
                .then(json => {
                    const tbody = document.querySelector("#runTable tbody");
                    json.data.forEach((run, i) => {
                        const tr = document.createElement("tr");
                        const date = new Date(run.date * 1000).toLocaleDateString();
                        const time = new Date(run.time * 1000).toISOString().substring(14, 23);

                        tr.innerHTML = `
                            <td>${i + 1}</td>
                            <td>${run.name}</td>
                            <td>${time}</td>
                            <td>${date}</td>
                            <td>
                                <button onclick="viewRun('${run.id}', '${run.unique_id}', '${run.name}', '${time}')">
                                    View
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    document.getElementById("loading").hidden = true;
                });
        });

        function viewRun(id, uniqueId, playerName, time) {
            const msg = document.getElementById("msg");
            msg.innerText = `Downloading replay and resources for ${playerName}...`;

            fetch(`/api/prepare-run?id=${id}&mapName=${mapName}&uniqueId=${uniqueId}`)
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        msg.innerText = "Ready.";
                        startLibrary(res.replayFilename, res.mapName, playerName, time);
                    } else {
                        msg.innerText = "Error: " + (res.error || "Unknown");
                    }
                });
        }

        function startLibrary(runFile, mapName, playerName, time) {
            document.getElementById("msg").innerText = "";
            viewer.load(runFile);
            viewer.setTitle(`${playerName} on ${mapName} done in ${time}`);
        }
    </script>
</head>

<body>
    <main class="container-fluid">
        <nav>
            <ul>
                <li><strong>HLKZ Replay Viewer</strong></li>
            </ul>
            <ul>
                <li><a href="/" role="button" class="secondary">Back to List</a></li>
            </ul>
        </nav>

        <hgroup>
            <h1 id="title">Loading...</h1>
            <h2>Pure Runs</h2>
        </hgroup>

        <div class="wrapper">
            <div class="list">
                <figure>
                    <table role="grid" id="runTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Time</th>
                                <th>Date</th>
                                <th>View</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" id="loading"><progress /></td>
                            </tr>
                        </tbody>
                    </table>
                </figure>
            </div>

            <div class="viewer">
                <p id="msg"><small>Select a run to begin.</small></p>
                <div id="player-container">
                    Waiting for selection...
                </div>
            </div>
        </div>
    </main>
</body>

</html>
