(function(X,G){typeof exports=="object"&&typeof module<"u"?G(exports):typeof define=="function"&&define.amd?define(["exports"],G):(X=typeof globalThis<"u"?globalThis:X||self,G(X.HLViewer={}))})(this,function(X){"use strict";var yi=Object.defineProperty;var wi=(X,G,fe)=>G in X?yi(X,G,{enumerable:!0,configurable:!0,writable:!0,value:fe}):X[G]=fe;var f=(X,G,fe)=>wi(X,typeof G!="symbol"?G+"":G,fe);let G=()=>({emit(e,...t){for(let s=this.events[e]||[],n=0,i=s.length;n<i;n++)s[n](...t)},events:{},on(e,t){var s;return((s=this.events)[e]||(s[e]=[])).push(t),()=>{var n;this.events[e]=(n=this.events[e])==null?void 0:n.filter(i=>t!==i)}}});const fe=performance.now.bind(performance),pt=e=>{const t=Math.floor(e/60),s=Math.floor(e-t*60),n=t<10?`0${t}`:t.toString(),i=s<10?`0${s}`:s.toString();return`${n}:${i}`},jt=new AudioContext;class zt{constructor(){f(this,"context");f(this,"channels");f(this,"masterGain");f(this,"preMuteVolume");f(this,"events");this.context=jt,this.events=G();const t=Number.parseFloat(localStorage.getItem("volume")||"0.3");localStorage.setItem("volume",t.toString()),this.channels=[],this.preMuteVolume=1,this.masterGain=this.context.createGain(),this.masterGain.gain.value=t,this.masterGain.connect(this.context.destination);for(let s=0;s<8;++s)this.channels.push({source:null,gain:this.context.createGain()}),this.channels[s].gain.connect(this.masterGain)}static getContext(){return jt}play(t,s,n){this.stop(s);const i=this.channels[s].gain;i.gain.value=Math.max(0,Math.min(1,n));const r=this.context.createBufferSource();r.buffer=t.buffer,r.connect(i),r.start(0),this.channels[s].source=r}stop(t){const s=this.channels[t].source;s&&s.stop(0)}getVolume(){return this.masterGain.gain.value}setVolume(t){const s=this.masterGain.gain.value;s>0&&t===0&&(this.preMuteVolume=s),this.masterGain.gain.value=t,localStorage.setItem("volume",t.toString()),this.events.emit("volumeChange",t)}toggleMute(){this.getVolume()===0?this.setVolume(this.preMuteVolume):this.setVolume(0)}}class Et{constructor(t){f(this,"index");f(this,"name");f(this,"buffer");this.index=-1,this.name="",this.buffer=t}static create(t){return new Promise((s,n)=>{zt.getContext().decodeAudioData(t,i=>{s(new Et(i))},i=>{n(i)})})}}function qt(e,t){return e.slice(e.lastIndexOf("/")+1).replace(t||"","")}function bs(e){const t=e.lastIndexOf("/"),s=e.lastIndexOf(".");return t<s?e.slice(s):""}var O=(e=>(e[e.UByte=0]="UByte",e[e.Byte=1]="Byte",e[e.UShort=2]="UShort",e[e.Short=3]="Short",e[e.UInt=4]="UInt",e[e.Int=5]="Int",e[e.Float=6]="Float",e[e.Double=7]="Double",e[e.NString=8]="NString",e[e.String=9]="String",e))(O||{});class ie{constructor(t){f(this,"data");f(this,"offset");this.data=new DataView(t),this.offset=0}length(){return this.data.byteLength}tell(){return this.offset}seek(t){this.offset=Math.max(0,t)}skip(t){this.seek(this.tell()+t)}b(){const t=this.data.getInt8(this.offset);return this.skip(1),t}ub(){const t=this.data.getUint8(this.offset);return this.skip(1),t}s(t=!0){const s=this.data.getInt16(this.offset,t);return this.skip(2),s}us(t=!0){const s=this.data.getUint16(this.offset,t);return this.skip(2),s}i(t=!0){const s=this.data.getInt32(this.tell(),t);return this.skip(4),s}ui(t=!0){const s=this.data.getUint32(this.tell(),t);return this.skip(4),s}f(t=!0){const s=this.data.getFloat32(this.tell(),t);return this.skip(4),s}lf(t=!0){const s=this.data.getFloat64(this.tell(),t);return this.skip(8),s}str(){let t=this.ub(),s="";for(;t!==0;)s+=String.fromCharCode(t),t=this.ub();return s}nstr(t){let s=t;if(s<0)return"";let n="";for(;s>0;){s-=1;const i=this.ub();if(i===0)break;n+=String.fromCharCode(i)}return s!==0&&this.skip(s),n}arr(t,s){let n=t;s.bind(this);const i=[];for(;n-- >0;)i.push(s());return i}arrx(t,s,n=0){switch(s){case 0:{const i=new Uint8Array(this.data.buffer,this.tell(),t);return this.skip(t),i}case 1:{const i=new Int8Array(this.data.buffer,this.tell(),t);return this.skip(t),i}case 2:{const i=new Uint16Array(this.data.buffer,this.tell(),t);return this.skip(t*2),i}case 3:{const i=new Int16Array(this.data.buffer,this.tell(),t);return this.skip(t*2),i}case 4:{const i=new Uint32Array(this.data.buffer,this.tell(),t);return this.skip(t*4),i}case 5:{const i=new Int32Array(this.data.buffer,this.tell(),t);return this.skip(t*4),i}case 6:{const i=new Float32Array(this.data.buffer,this.tell(),t);return this.skip(t*4),i}case 7:{const i=new Float64Array(this.data.buffer,this.tell(),t);return this.skip(t*8),i}case 8:{let i=t;const r=[];for(;i-- >0;)r.push(this.nstr(n));return r}case 9:{let i=t;const r=[];for(;i-- >0;)r.push(this.str());return r}}}}class vt{constructor(t,s,n,i){f(this,"name");f(this,"width");f(this,"height");f(this,"data");this.name=t,this.width=s,this.height=n,this.data=i}static parse(t,s){const n=new ie(t),i={idLength:n.ub(),colorMapType:n.ub(),imageType:n.ub(),colorMap:{firstEntryIndex:n.us(),length:n.us(),size:n.ub()},image:{xOrigin:n.us(),yOrigin:n.us(),width:n.us(),height:n.us(),depth:n.ub(),descriptor:n.ub()}};if(i.idLength&&n.arrx(i.idLength,O.UByte),i.colorMapType)throw new Error("Not implemented");const r=i.image.width,a=i.image.height,o=r*a;let l=new Uint8Array(0);if(i.imageType===2){const c=o*i.image.depth/8;if(l=n.arrx(c,O.UByte),i.image.depth===24){const u=new Uint8Array(o*4);for(let h=0;h<a;++h)for(let g=0;g<r;++g){const d=(a-1-h)*r+g;u[d*4]=l[(h*r+g)*3+2],u[d*4+1]=l[(h*r+g)*3+1],u[d*4+2]=l[(h*r+g)*3],u[d*4+3]=255}l=u}else if(i.image.depth===32){const u=new Uint8Array(o*4);for(let h=0;h<a;++h)for(let g=0;g<r;++g){const d=(a-1-h)*r+g;u[d*4]=l[(h*r+g)*4+2],u[d*4+1]=l[(h*r+g)*4+1],u[d*4+2]=l[(h*r+g)*4],u[d*4+3]=255}l=u}}else if(i.imageType===10&&(l=new Uint8Array(o*4),i.image.depth===24))for(let c=0;c<a;++c)for(let u=0;u<r;){let h=n.ub();if(h&128){h=(h&127)+1;const g=n.ub(),d=n.ub(),m=n.ub();for(;u<r&&h;){const p=(a-1-c)*r+u;l[p*4]=m,l[p*4+1]=d,l[p*4+2]=g,l[p*4+3]=255,++u,--h}}else for(h=(h&127)+1;u<r&&h;){const g=(a-1-c)*r+u;l[g*4+2]=n.ub(),l[g*4+1]=n.ub(),l[g*4]=n.ub(),l[g*4+3]=255,++u,--h}}return new vt(s,i.image.width,i.image.height,l)}}function Ge(e,t){const s=new Uint8Array(e.length*4),n=e.length;for(let i=0;i<n;++i)s[i*4]=t[e[i]*3],s[i*4+1]=t[e[i]*3+1],s[i*4+2]=t[e[i]*3+2],s[i*4+3]=255;return s}function Le(e,t){const s=new Uint8Array(e.length*4),n=e.length;for(let i=0;i<n;++i)e[i]===255?s[i*4+3]=0:(s[i*4]=t[e[i]*3],s[i*4+1]=t[e[i]*3+1],s[i*4+2]=t[e[i]*3+2],s[i*4+3]=255);return s}function xs(e){const t=e.nstr(16),s=e.ui(),n=e.ui();e.skip(4*4);const i=s*n,r=e.arrx(i,O.UByte);e.skip(21*(i/64)),e.skip(2);const a=e.arrx(768,O.UByte),o=t[0]==="{"?Le(r,a):Ge(r,a);return{type:"decal",name:t,width:s,height:n,data:o}}const As=(e,t)=>({type:"cache",name:t.name});function Ms(e){const t=e.nstr(16),s=e.ui(),n=e.ui();e.skip(4*4);const i=s*n,r=e.arrx(i,O.UByte);e.skip(21*(i/64)),e.skip(2);const a=e.arrx(768,O.UByte),o=t[0]==="{"?Le(r,a):Ge(r,a);return{type:"texture",name:t,width:s,height:n,data:o}}function Is(e,t){const s=e.ui()&&256,n=e.ui(),i=e.ui(),r=e.ui(),a=[];for(let u=0;u<256;++u){const h=e.us(),g=e.us();a.push({x:h%s,y:Math.floor(h/s)/r*r,width:g,height:r})}const o=s*n,l=e.arrx(o,O.UByte);e.skip(2);const c=e.arrx(256*3,O.UByte);return{type:"font",name:t.name,width:s,height:n,rowCount:i,rowHeight:r,glyphs:a,data:Le(l,c)}}const _s=(e,t)=>({type:"unknown",name:t.name,data:e.arrx(t.length,O.UByte)});function Rs(e,t){switch(e.seek(t.offset),t.type){case 64:return xs(e);case 66:return As(e,t);case 67:return Ms(e);case 70:return Is(e,t);default:return _s(e,t)}}class Tt{constructor(t){f(this,"entries");this.entries=t}static parse(t){const s=new ie(t);if(s.nstr(4)!=="WAD3")throw new Error("Invalid WAD file format");const i=s.ui(),r=s.ui();s.seek(r);const a=[];for(let l=0;l<i;++l){const c={offset:s.ui(),diskLength:s.ui(),length:s.ui(),type:s.b(),isCompressed:s.b(),name:""};s.skip(2),c.name=s.nstr(16),a.push(c)}const o=a.map(l=>Rs(s,l));return new Tt(o)}}class yt{constructor(t){f(this,"name");f(this,"chunks");f(this,"resources");this.name=qt(t,".bsp"),this.chunks=[],this.resources={sounds:[],skins:[],models:[],decals:[],custom:[],events:[]}}setResources(t){for(const s of t)switch(s.type){case 0:{s.used=!1,this.resources.sounds.push(s);break}case 1:{this.resources.skins.push(s);break}case 2:{this.resources.models.push(s);break}case 3:{this.resources.decals.push(s);break}case 4:{this.resources.custom.push(s);break}case 5:{this.resources.events.push(s);break}}}addChunk(t){this.chunks.push(t)}}class wt{constructor(t,s){f(this,"state");f(this,"startTime");f(this,"timeLength");f(this,"data");f(this,"reader");this.state=t.clone(),this.startTime=s,this.timeLength=10,this.data=null,this.reader=null}setData(t){this.data=new Uint8Array(t.length);for(let s=0;s<t.length;++s)this.data[s]=t[s];this.reader=new ie(this.data.buffer)}}class He{constructor(t=null){f(this,"cameraPos");f(this,"cameraRot");f(this,"entities");t?(this.cameraPos=JSON.parse(JSON.stringify(t.cameraPos)),this.cameraRot=JSON.parse(JSON.stringify(t.cameraRot)),this.entities=JSON.parse(JSON.stringify(t.entities))):(this.cameraPos=[0,0,0],this.cameraRot=[0,0,0],this.entities=[])}feedFrame(t){switch(t.type){case 0:case 1:{this.cameraPos[0]=t.camera.position[0],this.cameraPos[1]=t.camera.position[1],this.cameraPos[2]=t.camera.position[2],this.cameraRot[0]=t.camera.orientation[0],this.cameraRot[1]=t.camera.orientation[1],this.cameraRot[2]=t.camera.orientation[2];break}}}feedHlkzFrame(t){this.cameraPos[0]=t.x,this.cameraPos[1]=t.y,this.cameraPos[2]=t.z,this.cameraRot[0]=t.angle_x,this.cameraRot[1]=t.angle_y,this.cameraRot[2]=t.angle_z}clone(){return new He(this)}}function kt(e){const t=e.readBits(1),s=e.readBits(1);if(!t&&!s)return 0;const n=e.readBits(1);let i=0,r=0;t&&(i=e.readBits(12)),s&&(r=e.readBits(3));let a=i+r/32;return n&&(a=-a),a}var D=(e=>(e[e.DT_BYTE=1]="DT_BYTE",e[e.DT_SHORT=2]="DT_SHORT",e[e.DT_FLOAT=4]="DT_FLOAT",e[e.DT_INTEGER=8]="DT_INTEGER",e[e.DT_ANGLE=16]="DT_ANGLE",e[e.DT_TIMEWINDOW_8=32]="DT_TIMEWINDOW_8",e[e.DT_TIMEWINDOW_BIG=64]="DT_TIMEWINDOW_BIG",e[e.DT_STRING=128]="DT_STRING",e[e.DT_SIGNED=-2147483648]="DT_SIGNED",e))(D||{});function re(e,t){const s={},n=e.readBits(3),i=[];for(let a=0;a<n;++a)i.push(e.readBits(8));let r=!1;for(let a=0;a<n;++a){for(let o=0;o<8;++o){const l=o+a*8;if(l===t.length){r=!0;break}if(i[a]&1<<o)if(t[l].flags&D.DT_BYTE)if(t[l].flags&D.DT_SIGNED){const c=e.readBits(1)?-1:1,u=e.readBits(t[l].bits-1),h=t[l].divisor;s[t[l].name]=c*u/h}else{const c=e.readBits(t[l].bits),u=t[l].divisor;s[t[l].name]=c/u}else if(t[l].flags&D.DT_SHORT)if(t[l].flags&D.DT_SIGNED){const c=e.readBits(1)?-1:1,u=e.readBits(t[l].bits-1),h=t[l].divisor;s[t[l].name]=c*u/h}else{const c=e.readBits(t[l].bits),u=t[l].divisor;s[t[l].name]=c/u}else if(t[l].flags&D.DT_INTEGER)if(t[l].flags&D.DT_SIGNED){const c=e.readBits(1)?-1:1,u=e.readBits(t[l].bits-1),h=t[l].divisor;s[t[l].name]=c*u/h}else{const c=e.readBits(t[l].bits),u=t[l].divisor;s[t[l].name]=c/u}else if(t[l].flags&D.DT_FLOAT||t[l].flags&D.DT_TIMEWINDOW_8||t[l].flags&D.DT_TIMEWINDOW_BIG)if(t[l].flags&D.DT_SIGNED){const c=e.readBits(1)?-1:1,u=e.readBits(t[l].bits-1),h=t[l].divisor;s[t[l].name]=c*u/h}else{const c=e.readBits(t[l].bits),u=t[l].divisor;s[t[l].name]=c/u}else if(t[l].flags&D.DT_ANGLE){const c=e.readBits(t[l].bits),u=360/(1<<t[l].bits);s[t[l].name]=c*u}else t[l].flags&D.DT_STRING&&(s[t[l].name]=e.readString())}if(r)break}return s}const Ls={delta_description_t:[{name:"flags",bits:32,divisor:1,flags:D.DT_INTEGER},{name:"name",bits:8,divisor:1,flags:D.DT_STRING},{name:"offset",bits:16,divisor:1,flags:D.DT_INTEGER},{name:"size",bits:8,divisor:1,flags:D.DT_INTEGER},{name:"bits",bits:8,divisor:1,flags:D.DT_INTEGER},{name:"divisor",bits:32,divisor:4e3,flags:D.DT_FLOAT},{name:"preMultiplier",bits:32,divisor:4e3,flags:D.DT_FLOAT}]},Vt=()=>({...Ls}),ve=class ve{constructor(t){f(this,"view");this.view=new Uint8Array(t,0,t.byteLength)}getBits(t,s,n=!1){let i=t;const r=this.view.length*8-i;if(s>r)throw new Error("Bits out of bounds");let a=0;for(let o=0;o<s;){const l=s-o,c=i&7,u=this.view[i>>3],h=Math.min(l,8-c),g=(1<<h)-1,d=u>>c&g;a|=d<<o,i+=h,o+=h}return n?(s!==32&&a&1<<s-1&&(a|=-1^(1<<s)-1),a):a>>>0}getInt8(t){return this.getBits(t,8,!0)}getUint8(t){return this.getBits(t,8,!1)}getInt16(t){return this.getBits(t,16,!0)}getUint16(t){return this.getBits(t,16,!1)}getInt32(t){return this.getBits(t,32,!0)}getUint32(t){return this.getBits(t,32,!1)}getFloat32(t){return ve.scratch.setUint32(0,this.getUint32(t)),ve.scratch.getFloat32(0)}getFloat64(t){return ve.scratch.setUint32(0,this.getUint32(t)),ve.scratch.setUint32(4,this.getUint32(t+32)),ve.scratch.getFloat64(0)}};f(ve,"scratch",new DataView(new ArrayBuffer(8)));let bt=ve;class te{constructor(t){f(this,"view");f(this,"index");this.view=new bt(t),this.index=0}readBits(t,s=!1){const n=this.view.getBits(this.index,t,s);return this.index+=t,n}readInt8(){const t=this.view.getInt8(this.index);return this.index+=8,t}readUint8(){const t=this.view.getUint8(this.index);return this.index+=8,t}readInt16(){const t=this.view.getInt16(this.index);return this.index+=16,t}readUint16(){const t=this.view.getUint16(this.index);return this.index+=16,t}readInt32(){const t=this.view.getInt32(this.index);return this.index+=32,t}readUint32(){const t=this.view.getUint32(this.index);return this.index+=32,t}readFloat32(){const t=this.view.getFloat32(this.index);return this.index+=32,t}readFloat64(){const t=this.view.getFloat64(this.index);return this.index+=64,t}readString(t=0,s=!1){let n=0;const i=[];let r=!0;for(;!t||t&&n<t;){const o=this.readUint8();if(o===0&&(r=!1,!t))break;r&&i.push(o),n++}const a=String.fromCharCode.apply(null,i);if(s)try{return decodeURIComponent(a)}catch{return a}else return a}}const v={bad(){throw new Error("Invalid message type")},nop(){return null},disconnect(e){return{reason:e.str()}},event(e,t){const s=new te(e.data.buffer);s.index=e.tell()*8;const n=[],i=s.readBits(5);for(let r=0;r<i;++r){const a={index:s.readBits(10)};s.readBits(1)&&(a.packetIndex=s.readBits(11),s.readBits(1)&&(a.delta=re(s,t.event_t))),s.readBits(1)&&(a.fireTime=s.readBits(16)),n.push(a)}return s.index%8>0?e.seek(Math.floor(s.index/8)+1):e.seek(s.index/8),{events:n}},version(e){return{version:e.ui()}},setView(e){return{entityIndex:e.s()}},sound(e){const t=new te(e.data.buffer);t.index=e.tell()*8;const s=t.readBits(9);let n=1;(s&1)!==0&&(n=t.readBits(8)/255);let i=1;(s&2)!==0&&(i=t.readBits(8)/64);const r=t.readBits(3),a=t.readBits(11);let o;(s&4)!==0?o=t.readBits(16):o=t.readBits(8);const l=t.readBits(1),c=t.readBits(1),u=t.readBits(1);let h=0,g=0,d=0;l&&(h=kt(t)),c&&(g=kt(t)),u&&(d=kt(t));let m=1;return(s&8)!==0&&(m=t.readBits(8)),t.index%8>0?e.seek(Math.floor(t.index/8)+1):e.seek(t.index/8),{flags:s,volume:n,attenuation:i,channel:r,entityIndex:a,soundIndex:o,xPosition:h,yPosition:g,zPosition:d,pitch:m}},time(e){return{time:e.f()}},print(e){return{message:e.str()}},stuffText(e){return{commands:e.str().split(";").map(n=>{const i=n.split(/\s*("[^"]+"|[^\s"]+)/).map(o=>o.replace(/^"(.*)"$/,"$1").trim()).filter(o=>o),r=i[0],a=i.slice(1);return{func:r,params:a}})}},setAngle(e){return{pitch:e.s(),yaw:e.s(),roll:e.s()}},serverInfo(e){const t={protocol:e.i(),spawnCount:e.i(),mapCrc:e.i(),clientDllHash:e.arrx(16,O.UByte),maxPlayers:e.ub(),playerIndex:e.ub(),isDeathmatch:e.ub(),gameDir:e.str(),hostName:e.str(),mapFileName:e.str(),mapCycle:e.str()};return e.skip(1),t},lightStyle(e){return{index:e.ub(),lightInfo:e.str()}},updateUserInfo(e){return{clientIndex:e.ub(),clientUserId:e.ui(),clientUserInfo:e.str(),clientCdKeyHash:e.arrx(16,O.UByte)}},deltaDescription(e,t){const s={name:e.str(),fields:[]},n=new te(e.data.buffer),i=e.us();n.index=e.tell()*8;for(let r=0;r<i;++r)s.fields.push(re(n,t.delta_description_t));return t[s.name]=s.fields,n.index%8>0?e.seek(Math.floor(n.index/8)+1):e.seek(n.index/8),s},clientData(e,t){const s=new te(e.data.buffer);s.index=e.tell()*8,s.readBits(1)&&(s.index+=8);const i=t.clientdata_t,r=re(s,i),a=t.weapon_data_t;for(;s.readBits(1);)s.index+=6,re(s,a);return s.index%8>0?e.seek(Math.floor(s.index/8)+1):e.seek(s.index/8),{clientData:r}},stopSound(e){return{entityIndex:e.s()}},pings(e){const t=new te(e.data.buffer);t.index=e.tell()*8;const s=[];for(;t.readBits(1);)s.push({slot:t.readBits(8),ping:t.readBits(8),loss:t.readBits(8)});return t.index%8>0?e.seek(Math.floor(t.index/8)+1):e.seek(t.index/8),s},particle(e){return{position:[e.s()/8,e.s()/8,e.s()/8],direction:[e.b(),e.b(),e.b()],count:e.ub(),color:e.ub()}},damage(){return null},spawnStatic(e){const t={modelIndex:e.s(),sequence:e.b(),frame:e.b(),colorMap:e.s(),skin:e.b(),position:[],rotation:[]};return t.position[0]=e.s()/8,t.rotation[0]=e.b()*(360/256),t.position[1]=e.s()/8,t.rotation[1]=e.b()*(360/256),t.position[2]=e.s()/8,t.rotation[2]=e.b()*(360/256),t.renderMode=e.b(),t.renderMode&&(t.renderAmt=e.b(),t.renderColor=[e.ub(),e.ub(),e.ub()],t.renderFx=e.b()),t},eventReliable(e,t){const s=new te(e.data.buffer);s.index=e.tell()*8;const n=s.readBits(10),i=re(s,t.event_t),r=s.readBits(1);let a=0;return r&&(a=s.readBits(16)),s.index%8>0?e.seek(Math.floor(s.index/8)+1):e.seek(s.index/8),{eventIndex:n,eventData:i,delayBit:r,delay:a}},spawnBaseLine(e,t){const s=new te(e.data.buffer);s.index=e.tell()*8;const n=[];for(;;){const o=s.readBits(11);if(o===2047)break;const l=s.readBits(2);let c;l&1?o>0&&o<=32?c="entity_state_player_t":c="entity_state_t":c="custom_entity_state_t",n[o]=re(s,t[c])}if(s.readBits(5)!==31)throw new Error("Bad spawnbaseline");const r=s.readBits(6),a=[];for(let o=0;o<r;++o)a.push(re(s,t.entity_state_t));return s.index%8>0?e.seek(Math.floor(s.index/8)+1):e.seek(s.index/8),{entities:n,extraData:a}},tempEntity(e){const Ti=e.ub(),Y={};switch(Ti){case 0:{e.skip(24);break}case 1:{e.skip(20);break}case 2:{e.skip(6);break}case 3:{e.skip(11);break}case 4:{e.skip(6);break}case 5:{e.skip(10);break}case 6:{e.skip(12);break}case 7:{e.skip(17);break}case 8:{e.skip(16);break}case 9:{e.skip(6);break}case 10:{e.skip(6);break}case 11:{e.skip(6);break}case 12:{e.skip(8);break}case 13:{e.skip(8),e.s()&&e.skip(2);break}case 14:{e.skip(9);break}case 15:{e.skip(19);break}case 17:{e.skip(10);break}case 18:{e.skip(16);break}case 19:{e.skip(24);break}case 20:{e.skip(24);break}case 21:{e.skip(24);break}case 22:{e.skip(10);break}case 23:{e.skip(11);break}case 24:{e.skip(16);break}case 25:{e.skip(19);break}case 27:{e.skip(12);break}case 28:{e.skip(16);break}case 29:{Y.channel=e.b(),Y.x=e.s(),Y.y=e.s(),Y.effect=e.b(),Y.textColor=[e.ub(),e.ub(),e.ub(),e.ub()],Y.effectColor=[e.ub(),e.ub(),e.ub(),e.ub()],Y.fadeInTime=e.s(),Y.fadeOutTime=e.s(),Y.holdTime=e.s(),Y.effect&&(Y.effectTime=e.s()),Y.message=e.str();break}case 30:{e.skip(17);break}case 31:{e.skip(17);break}case 99:{e.skip(2);break}case 100:{e.skip(10);break}case 101:{e.skip(14);break}case 102:{e.skip(12);break}case 103:{e.skip(14);break}case 104:{e.skip(9);break}case 105:{e.skip(5);break}case 106:{e.skip(17);break}case 107:{e.skip(13);break}case 108:{e.skip(24);break}case 109:{e.skip(9);break}case 110:{e.skip(17);break}case 111:{e.skip(7);break}case 112:{e.skip(10);break}case 113:{e.skip(19);break}case 114:{e.skip(19);break}case 115:{e.skip(12);break}case 116:{e.skip(7);break}case 117:{e.skip(7);break}case 118:{e.skip(9);break}case 119:{e.skip(16);break}case 120:{e.skip(18);break}case 121:{e.skip(5);break}case 122:{e.skip(10);break}case 123:{e.skip(9);break}case 124:{e.skip(7);break}case 125:{e.skip(1);break}case 126:{e.skip(18);break}case 127:{e.skip(15);break}default:throw new Error("Unknown temp entity type")}return Y},setPause(e){return{isPaused:e.b()}},signOnNum(e){return{sign:e.b()}},centerPrint(e){return{message:e.str()}},killedMonster(){return null},foundSecret(){return null},spawnStaticSound(e){return{position:[e.s()/8,e.s()/8,e.s()/8],soundIndex:e.us(),volume:e.ub()/255,attenuation:e.ub()/64,entityIndex:e.us(),pitch:e.ub(),flags:e.ub()}},intermission(){return null},finale(e){return{text:e.str()}},cdTrack(e){return{track:e.b(),loopTrack:e.b()}},restore(e){const t=e.str(),s=e.ub(),n=[];for(let i=0;i<s;++i)n.push(e.str());return{saveName:t,maps:n}},cutscene(e){return{text:e.str()}},weaponAnim(e){return{sequenceNumber:e.b(),weaponModelBodyGroup:e.b()}},decalName(e){return{positionIndex:e.ub(),decalName:e.str()}},roomType(e){return{type:e.us()}},addAngle(e){return{angleToAdd:e.s()/(360/65536)}},newUserMsg(e){return{index:e.ub(),size:e.b(),name:e.nstr(16)}},packetEntities(e,t){const s=new te(e.data.buffer);s.index=e.tell()*8;const n=[];s.readBits(16);let i=0;for(;s.readBits(16)!==0;){s.index-=16,s.readBits(1)?i++:s.readBits(1)?i=s.readBits(11):i+=s.readBits(6);const o=s.readBits(1);s.readBits(1)&&(s.index+=6);let c="entity_state_t";i>0&&i<=32?c="entity_state_player_t":o&&(c="custom_entity_state_t"),n.push(re(s,t[c]))}return s.index%8>0?e.seek(Math.floor(s.index/8)+1):e.seek(s.index/8),{entityStates:n}},deltaPacketEntities(e,t){const s=new te(e.data.buffer);s.index=e.tell()*8,s.readBits(16),s.index+=8;const n=[];let i=0;for(;s.readBits(16)!==0;){s.index-=16;const a=s.readBits(1);if(s.readBits(1)?i=s.readBits(11):i+=s.readBits(6),a)continue;const l=s.readBits(1);let c="entity_state_t";i>0&&i<32?c="entity_state_player_t":l&&(c="custom_entity_state_t"),n[i]=re(s,t[c])}return s.index%8>0?e.seek(Math.floor(s.index/8)+1):e.seek(s.index/8),{entityStates:n}},choke(){return null},resourceList(e){const t=new te(e.data.buffer);t.index=e.tell()*8;const s=[],n=t.readBits(12);for(let i=0;i<n;++i){const r={type:t.readBits(4),name:t.readString(),index:t.readBits(12),size:t.readBits(24)};t.readBits(3)&4&&(t.index+=128),t.readBits(1)&&(t.index+=256),s.push(r)}if(t.readBits(1))for(;t.readBits(1);){const i=t.readBits(1)?5:10;t.index+=i}return t.index%8>0?e.seek(Math.floor(t.index/8)+1):e.seek(t.index/8),s},newMoveVars(e){return{gravity:e.f(),stopSpeed:e.f(),maxSpeed:e.f(),spectatorMaxSpeed:e.f(),acceleration:e.f(),airAcceleration:e.f(),waterAcceleration:e.f(),friction:e.f(),edgeFriction:e.f(),waterFriction:e.f(),entityGravity:e.f(),bounce:e.f(),stepSize:e.f(),maxVelocity:e.f(),zMax:e.f(),waveHeight:e.f(),footsteps:e.b(),rollAngle:e.f(),rollSpeed:e.f(),skyColor:[e.f(),e.f(),e.f()],skyVec:[e.f(),e.f(),e.f()],skyName:e.str()}},resourceRequest(e){const t={spawnCount:e.i()};return e.skip(4),t},customization(e){const t=e.ub(),s=e.ub(),n=e.str(),i=e.us(),r=e.ui(),a=e.ub();let o=null;return a&4&&(o=[e.i(),e.i(),e.i(),e.i()]),{playerIndex:t,type:s,name:n,index:i,downloadSize:r,flags:a,md5hash:o}},crosshairAngle(e){return{pitch:e.b(),yaw:e.b()}},soundFade(e){return{initialPercent:e.ub(),holdTime:e.ub(),fadeOutTime:e.ub(),fadeInTime:e.ub()}},fileTxferFailed(e){return{filename:e.str()}},hltv(e){return{mode:e.ub()}},director(e){const t=e.ub();return{flag:e.ub(),message:e.nstr(t-1)}},voiceInit(e){return{codecName:e.str(),quality:e.b()}},voiceData(e){const t=e.ub(),s=e.us(),n=e.arrx(s,O.UByte);return{playerIndex:t,data:n}},sendExtraInfo(e){return{fallbackDir:e.str(),canCheat:e.ub()}},timeScale(e){return{timeScale:e.f()}},resourceLocation(e){return{url:e.str()}},sendCvarValue(e){return{name:e.str()}},sendCvarValue2(e){return{requestId:e.ui(),name:e.str()}}},Ps=[v.bad,v.nop,v.disconnect,v.event,v.version,v.setView,v.sound,v.time,v.print,v.stuffText,v.setAngle,v.serverInfo,v.lightStyle,v.updateUserInfo,v.deltaDescription,v.clientData,v.stopSound,v.pings,v.particle,v.damage,v.spawnStatic,v.eventReliable,v.spawnBaseLine,v.tempEntity,v.setPause,v.signOnNum,v.centerPrint,v.killedMonster,v.foundSecret,v.spawnStaticSound,v.intermission,v.finale,v.cdTrack,v.restore,v.cutscene,v.weaponAnim,v.decalName,v.roomType,v.addAngle,v.newUserMsg,v.packetEntities,v.deltaPacketEntities,v.choke,v.resourceList,v.newMoveVars,v.resourceRequest,v.customization,v.crosshairAngle,v.soundFade,v.fileTxferFailed,v.hltv,v.director,v.voiceInit,v.voiceData,v.sendExtraInfo,v.timeScale,v.resourceLocation,v.sendCvarValue,v.sendCvarValue2];function Kt(e,t,s){if(t===0)return null;const n=Ps[t];return n?n(e,s):null}var de=(e=>(e[e.BAD=0]="BAD",e[e.NOP=1]="NOP",e[e.DISCONNECT=2]="DISCONNECT",e[e.EVENT=3]="EVENT",e[e.VERSION=4]="VERSION",e[e.SETVIEW=5]="SETVIEW",e[e.SOUND=6]="SOUND",e[e.TIME=7]="TIME",e[e.PRINT=8]="PRINT",e[e.STUFFTEXT=9]="STUFFTEXT",e[e.SETANGLE=10]="SETANGLE",e[e.SERVERINFO=11]="SERVERINFO",e[e.LIGHTSTYLE=12]="LIGHTSTYLE",e[e.UPDATEUSERINFO=13]="UPDATEUSERINFO",e[e.DELTADESCRIPTION=14]="DELTADESCRIPTION",e[e.CLIENTDATA=15]="CLIENTDATA",e[e.STOPSOUND=16]="STOPSOUND",e[e.PINGS=17]="PINGS",e[e.PARTICLE=18]="PARTICLE",e[e.DAMAGE=19]="DAMAGE",e[e.SPAWN=20]="SPAWN",e[e.EVENT_RELIABLE=21]="EVENT_RELIABLE",e[e.SPAWNBASELINE=22]="SPAWNBASELINE",e[e.TEMPENTITY=23]="TEMPENTITY",e[e.SETPAUSE=24]="SETPAUSE",e[e.SIGNONNUM=25]="SIGNONNUM",e[e.CENTERPRINT=26]="CENTERPRINT",e[e.KILLEDMONSTER=27]="KILLEDMONSTER",e[e.FOUNDSECRET=28]="FOUNDSECRET",e[e.SPAWNSTATICSOUND=29]="SPAWNSTATICSOUND",e[e.INTERMISSION=30]="INTERMISSION",e[e.FINALE=31]="FINALE",e[e.CDTRACK=32]="CDTRACK",e[e.RESTORE=33]="RESTORE",e[e.CUTSCENE=34]="CUTSCENE",e[e.WEAPONANIM=35]="WEAPONANIM",e[e.DECALNAME=36]="DECALNAME",e[e.ROOMTYPE=37]="ROOMTYPE",e[e.ADDANGLE=38]="ADDANGLE",e[e.NEWUSERMSG=39]="NEWUSERMSG",e[e.PACKETENTITIES=40]="PACKETENTITIES",e[e.DELTAPACKETENTITIES=41]="DELTAPACKETENTITIES",e[e.CHOKE=42]="CHOKE",e[e.RESOURCELIST=43]="RESOURCELIST",e[e.NEWMOVEVARS=44]="NEWMOVEVARS",e[e.RESOURCEREQUEST=45]="RESOURCEREQUEST",e[e.CUSTOMIZATION=46]="CUSTOMIZATION",e[e.CROSSHAIRANGLE=47]="CROSSHAIRANGLE",e[e.SOUNDFADE=48]="SOUNDFADE",e[e.FILETXFERFAILED=49]="FILETXFERFAILED",e[e.HLTV=50]="HLTV",e[e.DIRECTOR=51]="DIRECTOR",e[e.VOICEINIT=52]="VOICEINIT",e[e.VOICEDATA=53]="VOICEDATA",e[e.SENDEXTRAINFO=54]="SENDEXTRAINFO",e[e.TIMESCALE=55]="TIMESCALE",e[e.RESOURCELOCATION=56]="RESOURCELOCATION",e[e.SENDCVARVALUE=57]="SENDCVARVALUE",e[e.SENDCVARVALUE2=58]="SENDCVARVALUE2",e))(de||{});const Ss=e=>e.nstr(8)==="HLDEMO",Zt=e=>({demoProtocol:e.ui(),netProtocol:e.ui(),mapName:e.nstr(260),modName:e.nstr(260),mapCrc:e.i(),dirOffset:e.ui()}),Yt=(e,t)=>{e.seek(t);const s=e.ui(),n=[];for(let i=0;i<s;++i)n.push({id:e.ui(),name:e.nstr(64),flags:e.ui(),cdTrack:e.i(),time:e.f(),frames:e.ui(),offset:e.ui(),length:e.ui()});return n},Ns=(e,t,s)=>{const n=e.ui(),i=e.tell()+n,r=[];for(;e.tell()<i;){const a=e.ub();if(a===1)continue;if(a>=64){s[a]&&s[a].size>-1?e.skip(s[a].size):e.skip(e.ub());continue}const o=Kt(e,a,t);o?(a===39&&(s[o.index]=o),r.push({type:a,data:o})):e.seek(i)}return e.seek(i),r},Xe=(e,t,s)=>{const n={type:e.ub(),time:e.f(),tick:e.ui()};switch(n.type){case 0:case 1:{e.skip(4),n.camera={position:[e.f(),e.f(),e.f()],orientation:[e.f(),e.f(),e.f()]},e.skip(436),n.data=Ns(e,t,s);break}case 2:break;case 3:{n.command=e.nstr(64);break}case 4:{e.skip(32);break}case 5:break;case 6:{e.skip(84);break}case 7:{e.skip(8);break}case 8:{n.sound={channel:e.i(),sample:e.nstr(e.ui()),attenuation:e.f(),volume:e.f(),flags:e.ui(),pitch:e.i()};break}case 9:{e.skip(e.ui());break}default:{n.error=!0;break}}return n};var ye=(e=>(e[e.DEMO=0]="DEMO",e[e.HLKZ=1]="HLKZ",e))(ye||{});class ke{constructor(t,s){f(this,"header");f(this,"mapName");f(this,"directories");this.header=t,this.mapName=this.header.mapName,this.directories=s}static parseFromArrayBuffer(t){const s=new ie(t);if(s.nstr(8)!=="HLDEMO")throw new Error("Invalid replay format");const i={};i.demoProtocol=s.ui(),i.netProtocol=s.ui(),i.mapName=s.nstr(260),i.modName=s.nstr(260),i.mapCrc=s.i(),i.dirOffset=s.ui(),s.seek(i.dirOffset);const r=s.ui(),a=[];for(let o=0;o<r;++o)a.push({id:s.ui(),name:s.nstr(64),flags:s.ui(),cdTrack:s.i(),time:s.f(),frames:s.ui(),offset:s.ui(),length:s.ui(),macros:[]});for(let o=0;o<a.length;++o){s.seek(a[o].offset);let l=!1;for(;!l;){const c={type:s.b(),time:s.f(),frame:s.ui()};switch(c.type){case 0:case 1:{s.skip(4),c.camera={position:[s.f(),s.f(),s.f()],orientation:[s.f(),s.f(),s.f()]},s.skip(436),s.skip(s.ui());break}case 2:break;case 3:{c.command=s.nstr(64);break}case 4:{s.skip(32);break}case 5:{l=!0;break}case 6:{s.skip(84);break}case 7:{s.skip(8);break}case 8:{s.skip(4),s.skip(s.ui()+16);break}case 9:{s.skip(s.ui());break}default:{const u=Number(s.tell()-9).toString(16),h=[`Unexpected macro (${c.type})`,` at offset = ${u}.`].join("");throw new Error(h)}}a[o].macros.push(c)}}return new ke(i,a)}static parseFullFromArrayBuffer(t){const s=new ie(t);if(s.nstr(8)!=="HLDEMO")throw new Error("Invalid replay format");const i={};i.demoProtocol=s.ui(),i.netProtocol=s.ui(),i.mapName=s.nstr(260),i.modName=s.nstr(260),i.mapCrc=s.i(),i.dirOffset=s.ui(),s.seek(i.dirOffset);const r=s.ui(),a=[];for(let c=0;c<r;++c)a.push({id:s.ui(),name:s.nstr(64),flags:s.ui(),cdTrack:s.i(),time:s.f(),frames:s.ui(),offset:s.ui(),length:s.ui(),macros:[]});const o=Vt(),l=[];for(let c=0;c<a.length;++c){s.seek(a[c].offset);let u=!1;for(;!u;){const h={type:s.b(),time:s.f(),frame:s.ui()};switch(h.type){case 0:case 1:{s.skip(4),h.camera={position:[s.f(),s.f(),s.f()],orientation:[s.f(),s.f(),s.f()],forward:[s.f(),s.f(),s.f()],right:[s.f(),s.f(),s.f()],up:[s.f(),s.f(),s.f()]},h.RefParams={frametime:s.f(),time:s.f(),intermission:s.i(),paused:s.i(),spectator:s.i(),onground:s.i(),waterlevel:s.i(),velocity:[s.f(),s.f(),s.f()],origin:[s.f(),s.f(),s.f()],viewHeight:[s.f(),s.f(),s.f()],idealPitch:s.f(),viewAngles:[s.f(),s.f(),s.f()],health:s.i(),crosshairAngle:[s.f(),s.f(),s.f()],viewSize:s.f(),punchAngle:[s.f(),s.f(),s.f()],maxClients:s.i(),viewEntity:s.i(),playerCount:s.i(),maxEntities:s.i(),demoPlayback:s.i(),hardware:s.i(),smoothing:s.i(),ptr_cmd:s.i(),ptr_movevars:s.i(),viewport:[s.i(),s.i(),s.i(),s.i()],nextView:s.i(),onlyClientDraw:s.i()},h.UserCmd={lerp_msec:s.s(),msec:s.ub(),UNUSED1:s.ub(),viewAngles:[s.f(),s.f(),s.f()],forwardMove:s.f(),sideMove:s.f(),upMove:s.f(),lightLevel:s.b(),UNUSED2:s.ub(),buttons:s.us(),impulse:s.b(),weaponSelect:s.b(),UNUSED:s.s(),impactIndex:s.i(),impactPosition:[s.f(),s.f(),s.f()]},h.MoveVars={gravity:s.f(),stopSpeed:s.f(),maxSpeed:s.f(),spectatorMaxSpeed:s.f(),acceleration:s.f(),airAcceleration:s.f(),waterAcceleration:s.f(),friction:s.f(),edgeFriction:s.f(),waterFriction:s.f(),entityGravity:s.f(),bounce:s.f(),stepSize:s.f(),maxVelocity:s.f(),zMax:s.f(),waveHeight:s.f(),footsteps:s.i(),skyName:s.nstr(32),rollAngle:s.f(),rollSpeed:s.f(),skyColor:[s.f(),s.f(),s.f()],skyVec:[s.f(),s.f(),s.f()]},h.view=[s.f(),s.f(),s.f()],h.viewModel=s.i(),h.incoming_sequence=s.i(),h.incoming_acknowledged=s.i(),h.incoming_reliable_acknowledged=s.i(),h.incoming_reliable_sequence=s.i(),h.outgoing_sequence=s.i(),h.reliable_sequence=s.i(),h.last_reliable_sequence=s.i();const d=s.ui()+s.tell();for(h.frameData=[];s.tell()<d;){const m=s.ub();if(m===1)continue;if(m>=64){l[m]&&l[m].size>-1?s.skip(l[m].size):s.skip(s.ub());continue}const p=Kt(s,m,o);p?(m===39&&(l[p.index]=p),h.frameData.push({type:m,frameData:p})):s.seek(d)}s.seek(d);break}case 2:break;case 3:{h.command=s.nstr(64);break}case 4:{h.clientData={position:[s.f(),s.f(),s.f()],rotation:[s.f(),s.f(),s.f()],weaponFlags:s.ui(),fov:s.f()};break}case 5:{u=!0;break}case 6:{h.event={flags:s.ui(),index:s.ui(),delay:s.f(),args:{flags:s.ui(),entityIndex:s.ui(),position:[s.f(),s.f(),s.f()],rotation:[s.f(),s.f(),s.f()],velocity:[s.f(),s.f(),s.f()],ducking:s.ui(),fparam1:s.f(),fparam2:s.f(),iparam1:s.i(),iparam2:s.i(),bparam1:s.i(),bparam2:s.i()}};break}case 7:{h.weaponAnimation={animation:s.i(),body:s.i()};break}case 8:{h.sound={channel:s.i(),sample:s.nstr(s.ui()),attenuation:s.f(),volume:s.f(),flags:s.ui(),pitch:s.i()};break}case 9:{s.skip(s.ui());break}default:{const g=Number(s.tell()-9).toString(16),d=`Unexpected macro (${h.type}) at offset = ${g}`;throw new Error(d)}}a[c].macros.push(h)}}return new ke(i,a)}static parseIntoChunks(t){const s=new ie(t);if(!Ss(s))throw new Error("Invalid replay file format");const n=[],i=Vt(),r=[],a=Zt(s),o=Yt(s,a.dirOffset);let l,c,u,h;const g=new He;let d=o[0].offset+o[0].length;for(s.seek(o[0].offset);s.tell()<d;){const m=Xe(s,i,r);if(g.feedFrame(m),m.error)throw new Error("Encountered error while reading replay");if(m.type<2){const p=m.data.find(T=>T.type===de.SERVERINFO);p&&(l=new yt(p.data.mapFileName),n.push(l));const E=m.data.find(T=>T.type===de.RESOURCELIST);E&&l&&l.setResources(E.data)}}if(!(l instanceof yt))throw new Error("Error while parsing replay.");for(h=s.tell(),c=new wt(g,0),l.addChunk(c),d=o[1].offset+o[1].length,s.seek(o[1].offset);;){const m=s.tell();if(m>=d){const E=u.time-c.startTime;c.timeLength=E;const T=m-h;s.seek(h),c.setData(s.arrx(T,O.UByte)),s.seek(m);break}const p=Xe(s,i,r);if(g.feedFrame(p),u=p,p.error)throw new Error("Encountered error while reading replay");if(p.type<2){const E=p.data.find(y=>y.type===de.SERVERINFO);if(E){l=new yt(E.data.mapFileName),n.push(l);const y=u.time-c.startTime;c.timeLength=y;const k=m-h,w=s.tell();s.seek(h),c.setData(s.arrx(k,O.UByte)),s.seek(w),h=m,c=new wt(g,p.time),l.addChunk(c)}const T=p.data.find(y=>y.type===de.RESOURCELIST);if(T&&l.setResources(T.data),E)continue;for(let y=0;y<p.data.length;++y){const k=p.data[y];if(k.type===de.SOUND||k.type===de.SPAWNSTATICSOUND){const w=l.resources.sounds.find(_=>_.index===k.data.soundIndex);w&&(w.used=!0)}else if(k.type===de.STUFFTEXT){const w=l.resources.sounds,_=k.data.commands;for(let C=0;C<_.length;++C){const M=_[C],b=M.func;if((b==="speak"||b==="spk")&&M.params.length===1){const x=`${M.params[0]}.wav`,A=w.find(F=>F.name===x);A&&(A.used=!0)}}}}}else if(p.type===8){const E=l.resources.sounds.find(T=>T.name===p.sound.sample);E&&(E.used=!0)}if(c.startTime+10<p.time){const E=m-h,T=s.tell();s.seek(h),c.setData(s.arrx(E,O.UByte)),s.seek(T),h=m,c=new wt(g,p.time),l.addChunk(c)}}return{length:o[1].time,maps:n,deltaDecoders:i,customMessages:r}}static readHeader(t){return Zt(t)}static readDirectories(t,s){return Yt(t,s)}static readFrame(t,s,n){return Xe(t,s,n)}static readFrameData(t,s,n){return Xe(t,s,n)}}var J=(e=>(e[e.VP_PARALLEL_UPRIGHT=0]="VP_PARALLEL_UPRIGHT",e[e.FACING_UPRIGHT=1]="FACING_UPRIGHT",e[e.VP_PARALLEL=2]="VP_PARALLEL",e[e.ORIENTED=3]="ORIENTED",e[e.VP_PARALLEL_ORIENTED=4]="VP_PARALLEL_ORIENTED",e))(J||{});class xt{constructor(t,s){f(this,"header");f(this,"frames");this.header=t,this.frames=s}static parse(t){const s=new ie(t);if(s.nstr(4)!=="IDSP")throw new Error("Invalid sprite file format");const i={version:s.i(),type:s.i(),alphaType:s.i(),radius:s.f(),width:s.i(),height:s.i(),frameCount:s.i(),beamLength:s.f(),syncType:s.i()},r=s.s(),a=s.arrx(r*3,O.UByte),o=[];for(let l=0;l<i.frameCount;++l){const c={group:s.i(),position:[s.i(),s.i()],width:s.i(),height:s.i(),data:new Uint8Array(i.width*i.height*4)},u=s.arrx(i.width*i.height,O.UByte);i.alphaType===3?c.data=Le(u,a):c.data=Ge(u,a),o.push(c)}return new xt(i,o)}}function be(e,t){const s=t.method||"GET",n=t.isBinary,i=t.progressCallback;if(!e)throw new Error("Url parameter missing");return new Promise((r,a)=>{const o=new XMLHttpRequest;n&&(o.responseType="arraybuffer"),n&&i&&o.addEventListener("progress",l=>{if(l.lengthComputable)i(o,l.loaded/l.total);else{const c=o.getResponseHeader("content-length");let u=0;c&&(u=Number.parseFloat(c));const h=o.getResponseHeader("content-encoding");if(u&&h&&h.indexOf("gzip")>-1){u*=4;const g=Math.min(.99,l.loaded/u);i(o,g)}else i(o,0)}}),o.addEventListener("readystatechange",()=>{o.readyState===4&&(o.status===200?(i&&i(o,1),r(o.response)):a({status:o.status}))}),o.open(s,e,!0),o.send()})}var me=typeof Float32Array<"u"?Float32Array:Array,Os=Math.PI/180;function We(e){return e*Os}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});function At(){var e=new me(16);return me!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function xe(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Pe(e,t,s){var n=s[0],i=s[1],r=s[2],a,o,l,c,u,h,g,d,m,p,E,T;return t===e?(e[12]=t[0]*n+t[4]*i+t[8]*r+t[12],e[13]=t[1]*n+t[5]*i+t[9]*r+t[13],e[14]=t[2]*n+t[6]*i+t[10]*r+t[14],e[15]=t[3]*n+t[7]*i+t[11]*r+t[15]):(a=t[0],o=t[1],l=t[2],c=t[3],u=t[4],h=t[5],g=t[6],d=t[7],m=t[8],p=t[9],E=t[10],T=t[11],e[0]=a,e[1]=o,e[2]=l,e[3]=c,e[4]=u,e[5]=h,e[6]=g,e[7]=d,e[8]=m,e[9]=p,e[10]=E,e[11]=T,e[12]=a*n+u*i+m*r+t[12],e[13]=o*n+h*i+p*r+t[13],e[14]=l*n+g*i+E*r+t[14],e[15]=c*n+d*i+T*r+t[15]),e}function Jt(e,t,s){var n=s[0],i=s[1],r=s[2];return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Se(e,t,s){var n=Math.sin(s),i=Math.cos(s),r=t[4],a=t[5],o=t[6],l=t[7],c=t[8],u=t[9],h=t[10],g=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=r*i+c*n,e[5]=a*i+u*n,e[6]=o*i+h*n,e[7]=l*i+g*n,e[8]=c*i-r*n,e[9]=u*i-a*n,e[10]=h*i-o*n,e[11]=g*i-l*n,e}function je(e,t,s){var n=Math.sin(s),i=Math.cos(s),r=t[0],a=t[1],o=t[2],l=t[3],c=t[8],u=t[9],h=t[10],g=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=r*i-c*n,e[1]=a*i-u*n,e[2]=o*i-h*n,e[3]=l*i-g*n,e[8]=r*n+c*i,e[9]=a*n+u*i,e[10]=o*n+h*i,e[11]=l*n+g*i,e}function Q(e,t,s){var n=Math.sin(s),i=Math.cos(s),r=t[0],a=t[1],o=t[2],l=t[3],c=t[4],u=t[5],h=t[6],g=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=r*i+c*n,e[1]=a*i+u*n,e[2]=o*i+h*n,e[3]=l*i+g*n,e[4]=c*i-r*n,e[5]=u*i-a*n,e[6]=h*i-o*n,e[7]=g*i-l*n,e}function Bs(e,t,s,n,i){var r=1/Math.tan(t/2),a;return e[0]=r/s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,i!=null&&i!==1/0?(a=1/(n-i),e[10]=(i+n)*a,e[14]=2*i*n*a):(e[10]=-1,e[14]=-2*n),e}var Ds=Bs;function ge(){var e=new me(3);return me!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function Us(e){var t=new me(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function oe(e,t,s){var n=new me(3);return n[0]=e,n[1]=t,n[2]=s,n}function Fs(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e}function Qt(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}function Cs(e,t){var s=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return Math.hypot(s,n,i)}var $s=Cs;(function(){var e=ge();return function(t,s,n,i,r,a){var o,l;for(s||(s=3),n||(n=0),i?l=Math.min(i*s+n,t.length):l=t.length,o=n;o<l;o+=s)e[0]=t[o],e[1]=t[o+1],e[2]=t[o+2],r(e,e,a),t[o]=e[0],t[o+1]=e[1],t[o+2]=e[2];return t}})();function Ne(){var e=new me(2);return me!=Float32Array&&(e[0]=0,e[1]=0),e}(function(){var e=Ne();return function(t,s,n,i,r,a){var o,l;for(s||(s=2),n||(n=0),i?l=Math.min(i*s+n,t.length):l=t.length,o=n;o<l;o+=s)e[0]=t[o],e[1]=t[o+1],r(e,e,a),t[o]=e[0],t[o+1]=e[1];return t}})();function Gs(e){let t=0,s="",n="";const i=[];for(let r=0;r<e.length;++r){const a=e[r];switch(t){case 0:{if(/\s/.test(a))continue;if(a==="{")i.push({}),t=1;else return[];break}case 1:{if(/\s/.test(a))continue;if(a==="}")t=0;else if(a==='"')s="",t=2;else return[];break}case 2:{a==='"'?t=3:s+=a;break}case 3:{if(/\s/.test(a))continue;a==='"'&&(n="",t=4);break}case 4:{a==='"'?(i[i.length-1][s]=n,t=1):n+=a;break}}}return i}class Hs{constructor(t,s,n,i,r){f(this,"name");f(this,"entities");f(this,"textures");f(this,"models");f(this,"lightmap");f(this,"skies",[]);f(this,"sprites",{});this.name=t,this.entities=s,this.textures=n,this.models=i,this.lightmap=r}}const Z=class Z{constructor(t){f(this,"lightmap");f(this,"texture");f(this,"block",new Uint16Array(Z.TEXTURE_SIZE));this.lightmap=t,this.texture=new Uint8Array(Z.TEXTURE_SIZE*Z.TEXTURE_SIZE*4),this.texture[this.texture.length-4]=255,this.texture[this.texture.length-3]=255,this.texture[this.texture.length-2]=255,this.texture[this.texture.length-1]=255}static init(t){return new Z(t)}getTexture(){return this.texture}processFace(t,s,n){const i=this.getDimensions(t),r=this.readLightmap(n,i.width,i.height);if(r)for(let a=0;a<t.length/7;++a){let o=t[a*7]*s.s[0]+t[a*7+1]*s.s[1]+t[a*7+2]*s.s[2]+s.sShift-i.minU;o+=r.x*16+8,o/=Z.TEXTURE_SIZE*16;let l=t[a*7]*s.t[0]+t[a*7+1]*s.t[1]+t[a*7+2]*s.t[2]+s.tShift-i.minV;l+=r.y*16+8,l/=Z.TEXTURE_SIZE*16,t[a*7+5]=o,t[a*7+6]=l}}getDimensions(t){let s=Math.floor(t[3]),n=Math.floor(t[4]),i=Math.floor(t[3]),r=Math.floor(t[4]);for(let a=1;a<t.length/7;++a)Math.floor(t[a*7+3])<s&&(s=Math.floor(t[a*7+3])),Math.floor(t[a*7+4])<n&&(n=Math.floor(t[a*7+4])),Math.floor(t[a*7+3])>i&&(i=Math.floor(t[a*7+3])),Math.floor(t[a*7+4])>r&&(r=Math.floor(t[a*7+4]));return{width:Math.ceil(i/16)-Math.floor(s/16)+1,height:Math.ceil(r/16)-Math.floor(n/16)+1,minU:Math.floor(s),minV:Math.floor(n)}}readLightmap(t,s,n){if(n<=0||s<=0)return null;const i=this.findFreeSpace(s,n);if(i){const r=[i.x,i.y],a=[s,n],o=[Z.TEXTURE_SIZE,Z.TEXTURE_SIZE],l=s*n;for(let c=0;c<l;++c){const u=r[1]*o[0]+r[0]+o[0]*Math.floor(c/a[0])+c%a[0];this.texture[u*4]=Math.min(255,this.lightmap[t+c*3]*2),this.texture[u*4+1]=Math.min(255,this.lightmap[t+c*3+1]*2),this.texture[u*4+2]=Math.min(255,this.lightmap[t+c*3+2]*2),this.texture[u*4+3]=255}}return i}findFreeSpace(t,s){let n=0,i=0,r=Z.TEXTURE_SIZE;for(let a=0;a<this.block.length-t;++a){let o=0,l=0;for(;l<t&&!(this.block[a+l]>=r);++l)this.block[a+l]>o&&(o=this.block[a+l]);l===t&&(n=a,i=r=o)}if(r+s>Z.TEXTURE_SIZE)return null;for(let a=0;a<t;++a)this.block[n+a]=r+s;return{x:n,y:i}}};f(Z,"TEXTURE_SIZE",1024);let Oe=Z;function Xs(e,t,s,n,i,r,a,o){const l=[];for(let c=0;c<e.length;++c){const u=e[c],h=[],g=new Float32Array(3),d=new Float32Array(3),m=new Float32Array(3),p=new Float32Array(2),E=new Float32Array(2),T=new Float32Array(2),y=new Float32Array(2),k=new Float32Array(2),w=new Float32Array(2),_=c===0?[0,0,0]:[0,0,0].map((M,b)=>(u.maxs[b]-u.mins[b])/2+u.mins[b]),C=oe(_[0],_[1],_[2]);for(let M=u.firstFace;M<u.firstFace+u.faceCount;++M){const b={buffer:new Float32Array((t[M].edgeCount-2)*21),textureIndex:-1},x=r[t[M].textureInfo],A=a[x.textureIndex],F=n.slice(t[M].firstEdge,t[M].firstEdge+t[M].edgeCount),q=s[Math.abs(F[0])][F[0]>0?0:1];g[0]=i[q][0],g[1]=i[q][1],g[2]=i[q][2],p[0]=g[0]*x.s[0]+g[1]*x.s[1]+g[2]*x.s[2]+x.sShift,p[1]=g[0]*x.t[0]+g[1]*x.t[1]+g[2]*x.t[2]+x.tShift,y[0]=0,y[1]=0;const $=s[Math.abs(F[1])][F[1]>0?0:1];d[0]=i[$][0],d[1]=i[$][1],d[2]=i[$][2],E[0]=d[0]*x.s[0]+d[1]*x.s[1]+d[2]*x.s[2]+x.sShift,E[1]=d[0]*x.t[0]+d[1]*x.t[1]+d[2]*x.t[2]+x.tShift,k[0]=0,k[1]=.999;let I=0;for(let U=2;U<t[M].edgeCount;++U){const ee=s[Math.abs(F[U])][F[U]>0?0:1];m[0]=i[ee][0],m[1]=i[ee][1],m[2]=i[ee][2],T[0]=m[0]*x.s[0]+m[1]*x.s[1]+m[2]*x.s[2]+x.sShift,T[1]=m[0]*x.t[0]+m[1]*x.t[1]+m[2]*x.t[2]+x.tShift,w[0]=.999,w[1]=.999,b.buffer[I++]=g[0],b.buffer[I++]=g[1],b.buffer[I++]=g[2],b.buffer[I++]=p[0],b.buffer[I++]=p[1],b.buffer[I++]=y[0],b.buffer[I++]=y[1],b.buffer[I++]=d[0],b.buffer[I++]=d[1],b.buffer[I++]=d[2],b.buffer[I++]=E[0],b.buffer[I++]=E[1],b.buffer[I++]=k[0],b.buffer[I++]=k[1],b.buffer[I++]=m[0],b.buffer[I++]=m[1],b.buffer[I++]=m[2],b.buffer[I++]=T[0],b.buffer[I++]=T[1],b.buffer[I++]=w[0],b.buffer[I++]=w[1],d[0]=m[0],d[1]=m[1],d[2]=m[2],E[0]=T[0],E[1]=T[1],k[0]=w[0],k[1]=w[1]}(x.flags===0||x.flags===-65536)&&o.processFace(b.buffer,x,t[M].lightmapOffset),b.textureIndex=x.textureIndex;for(let U=0;U<b.buffer.length/7;++U)b.buffer[U*7]-=C[0],b.buffer[U*7+1]-=C[1],b.buffer[U*7+2]-=C[2],b.buffer[U*7+3]/=A.width,b.buffer[U*7+4]/=A.height;h.push(b)}l.push({origin:C,faces:h})}return l}const Ws={parse(e,t){const s=new ie(t);if(s.ui()!==30)throw new Error("Invalid map version");const i=[];for(let E=0;E<15;++E)i.push({offset:s.ui(),length:s.ui()});const r=this.loadEntities(s,i[0].offset,i[0].length),a=this.loadTextures(s,i[2].offset),o=this.loadModels(s,i[14].offset,i[14].length),l=this.loadFaces(s,i[7].offset,i[7].length),c=this.loadEdges(s,i[12].offset,i[12].length),u=this.loadSurfEdges(s,i[13].offset,i[13].length),h=this.loadVertices(s,i[3].offset,i[3].length),g=this.loadTexInfo(s,i[6].offset,i[6].length),d=this.loadLightmap(s,i[8].offset,i[8].length),m=Oe.init(d),p=Xs(o,l,c,u,h,g,a,m);return new Hs(e,r,a,p,{width:Oe.TEXTURE_SIZE,height:Oe.TEXTURE_SIZE,data:m.getTexture()})},loadFaces(e,t,s){e.seek(t);const n=[];for(let i=0;i<s/20;++i)n.push({plane:e.us(),planeSide:e.us(),firstEdge:e.ui(),edgeCount:e.us(),textureInfo:e.us(),styles:[e.ub(),e.ub(),e.ub(),e.ub()],lightmapOffset:e.ui()});return n},loadModels(e,t,s){e.seek(t);const n=[];for(let i=0;i<s/64;++i)n.push({mins:[e.f(),e.f(),e.f()],maxs:[e.f(),e.f(),e.f()],origin:oe(e.f(),e.f(),e.f()),headNodes:[e.i(),e.i(),e.i(),e.i()],visLeaves:e.i(),firstFace:e.i(),faceCount:e.i()});return n},loadEdges(e,t,s){e.seek(t);const n=[];for(let i=0;i<s/4;++i)n.push([e.us(),e.us()]);return n},loadSurfEdges(e,t,s){e.seek(t);const n=[];for(let i=0;i<s/4;++i)n.push(e.i());return n},loadVertices(e,t,s){e.seek(t);const n=[];for(let i=0;i<s/12;++i)n.push([e.f(),e.f(),e.f()]);return n},loadTexInfo(e,t,s){e.seek(t);const n=[];for(let i=0;i<s/40;++i)n.push({s:[e.f(),e.f(),e.f()],sShift:e.f(),t:[e.f(),e.f(),e.f()],tShift:e.f(),textureIndex:e.i(),flags:e.i()});return n},loadLightmap(e,t,s){return e.seek(t),e.arrx(s,O.UByte)},loadTextureData(e){const t=e.nstr(16),s=e.ui(),n=e.ui(),i=!e.ui();if(i){const c=new Uint8Array(4);return c[0]=c[1]=c[2]=c[3]=255,{name:t,width:s,height:n,data:c,isExternal:i}}e.skip(3*4);const r=s*n,a=e.arrx(r,O.UByte);e.skip(21*(r/64)),e.skip(2);const o=e.arrx(768,O.UByte),l=t[0]==="{"?Le(a,o):Ge(a,o);return{name:t,width:s,height:n,data:l,isExternal:i}},loadTextures(e,t){e.seek(t);const s=e.ui(),n=[];for(let r=0;r<s;++r)n.push(e.ui());const i=[];for(let r=0;r<s;++r)n[r]===4294967295?i.push({name:"ERROR404",width:1,height:1,data:new Uint8Array([0,255,0,255]),isExternal:!1}):(e.seek(t+n[r]),i.push(this.loadTextureData(e)));return i},loadEntities(e,t,s){e.seek(t);const n=Gs(e.nstr(s)),i=["origin","angles","_diffuse_light","_light","rendercolor","avelocity"],r=["renderamt","rendermode","scale"],a=n[0];a.classname==="worldspawn"&&(a.model="*0",a.wad=a.wad||"",a.wad=a.wad.split(";").filter(o=>o.length).map(o=>o.replace(/\\/g,"/")).map(o=>qt(o)));for(const o of n){o.model&&(typeof o.renderamt>"u"&&(o.renderamt=0),typeof o.rendermode>"u"&&(o.rendermode=0),typeof o.renderfx>"u"&&(o.renderfx=0),typeof o.rendercolor>"u"&&(o.rendercolor="0 0 0"));for(const l of i)o[l]&&(o[l]=o[l].split(" ").map(c=>Number.parseFloat(c)));for(const l of r)o[l]&&(o[l]=Number.parseFloat(o[l]))}return n}};class W{}f(W,"BTN_JUMP",2),f(W,"BTN_DUCK",4),f(W,"BTN_FORWARD",8),f(W,"BTN_BACK",16),f(W,"BTN_USE",32),f(W,"BTN_MOVELEFT",512),f(W,"BTN_MOVERIGHT",1024);class Mt{static parse(t){const s=new ie(t);let n=t.byteLength/30;const i=Array(n),r=s.f();s.seek(0);for(let a=0;a<n;a++)i[a]=Mt.readFrame(s,r);return i}static readFrame(t,s){let n={gametime:t.f()-(s??0),x:t.f(),y:t.f(),z:t.f()+28,angle_x:t.f()*-3,angle_y:t.f(),angle_z:t.f(),buttons:t.us()};return n.buttons&W.BTN_DUCK&&(n.z-=16),n}}class js{constructor(t,s,n){f(this,"runType");f(this,"mapName");f(this,"data");f(this,"length");this.runType=t,this.mapName=s,this.data=Mt.parse(n),this.length=this.data[this.data.length-1].gametime}}class Ae{constructor(t){f(this,"name");f(this,"progress");f(this,"status");f(this,"data");this.name=t,this.progress=0,this.status=1,this.data=null}isLoading(){return this.status===1}skip(){this.status=2}isSkipped(){return this.status===2}error(){this.status=3}isError(){return this.status===3}done(t){this.status=4,this.data=t}isDone(){return this.status===4}}class zs extends Ae{constructor(){super(...arguments);f(this,"type","replay")}}class qs extends Ae{constructor(){super(...arguments);f(this,"type","bsp")}}class Vs extends Ae{constructor(){super(...arguments);f(this,"type","sky")}}class Ks extends Ae{constructor(){super(...arguments);f(this,"type","wad")}}class Zs extends Ae{constructor(){super(...arguments);f(this,"type","sound")}}class Ys extends Ae{constructor(){super(...arguments);f(this,"type","sprite")}}class Js{constructor(t){f(this,"config");f(this,"replay");f(this,"replayType",ye.DEMO);f(this,"map");f(this,"skies");f(this,"wads");f(this,"sounds");f(this,"sprites",{});f(this,"events");this.config=t,this.replay=void 0,this.map=void 0,this.skies=[],this.wads=[],this.sounds=[],this.events=G(),this.events.on("error",s=>{console.error(s)})}clear(){this.replay=void 0,this.map=void 0,this.skies.length=0,this.wads.length=0,this.sounds.length=0,this.sprites={}}checkStatus(){if(this.replay&&!this.replay.isDone()||this.map&&!this.map.isDone())return;for(let s=0;s<this.skies.length;++s)if(this.skies[s].isLoading())return;for(let s=0;s<this.wads.length;++s)if(this.wads[s].isLoading())return;for(let s=0;s<this.sounds.length;++s)if(this.sounds[s].isLoading())return;const t=Object.entries(this.sprites);for(let s=0;s<t.length;++s)if(t[s][1].isLoading())return;this.events.emit("loadall",this)}load(t){const s=bs(t);s===".dat"?this.loadHlkzReplay(t):s===".dem"?this.loadReplay(t):s===".bsp"?this.loadMap(t):this.events.emit("error","Invalid file extension",t)}async loadHlkzReplay(t){this.replayType=ye.HLKZ;const s=t.split("_");if(s.length<6)return;const n=s[s.length-2],i=s.slice(0,s.length-5).join("_"),r=await this.setupReplay(t);if(this.replay.isError())return;this.loadMap(`${i}.bsp`);const a=new js(n,i,r);this.replay.done(a),this.events.emit("load",this.replay),this.checkStatus()}async loadReplay(t){const s=await this.setupReplay(t);if(this.replay.isError())return;const n=ke.parseIntoChunks(s);this.replay.done(n),this.loadMap(`${n.maps[0].name}.bsp`);const i=n.maps[0].resources.sounds;for(const r of i)r.used&&this.loadSound(r.name,r.index);this.events.emit("load",this.replay),this.checkStatus()}async setupReplay(t){this.replay=new zs(t),this.events.emit("loadstart",this.replay);const s=(r,a)=>{this.replay&&(this.replay.progress=a),this.events.emit("progress",this.replay)},n=this.config.getReplaysPath();return await be(`${n}/${t}`,{method:"GET",isBinary:!0,progressCallback:s}).catch(r=>{this.replay&&this.replay.error(),this.events.emit("error",r,this.replay)})}async loadMap(t){this.map=new qs(t),this.events.emit("loadstart",this.map);const s=(o,l)=>{this.map&&(this.map.progress=l),this.events.emit("progress",this.map)},n=this.config.getMapsPath(),i=await be(`${n}/${t}`,{method:"GET",isBinary:!0,progressCallback:s}).catch(o=>{this.map&&this.map.error(),this.events.emit("error",o,this.map)});if(this.map.isError())return;const r=Ws.parse(t,i);this.map.done(r),r.entities.map(o=>{if(typeof o.model=="string"&&o.model.indexOf(".spr")>-1)return o.model}).filter((o,l,c)=>o&&c.indexOf(o)===l).map(o=>o&&this.loadSprite(o));const a=r.entities[0].skyname;if(a&&["bk","dn","ft","lf","rt","up"].map(l=>`${a}${l}`).map(l=>this.loadSky(l)),r.textures.find(o=>o.isExternal)){const l=r.entities[0].wad.map(c=>this.loadWad(c));await Promise.all(l)}this.events.emit("load",this.map),this.checkStatus()}async loadSprite(t){const s=new Ys(t);this.sprites[t]=s,this.events.emit("loadstart",s);const n=(a,o)=>{s.progress=o,this.events.emit("progress",s)},i=await be(`${this.config.getBasePath()}/${t}`,{method:"GET",isBinary:!0,progressCallback:n}).catch(a=>{s.error(),this.events.emit("error",a,s),this.checkStatus()});if(s.isError())return;const r=xt.parse(i);s.done(r),this.events.emit("load",s),this.checkStatus()}async loadSky(t){const s=new Vs(t);this.skies.push(s),this.events.emit("loadstart",s);const n=(o,l)=>{s.progress=l,this.events.emit("progress",s)},i=this.config.getSkiesPath(),r=await be(`${i}/${t}.tga`,{method:"GET",isBinary:!0,progressCallback:n}).catch(o=>{s.error(),this.events.emit("error",o,s),this.checkStatus()});if(s.isError())return;const a=vt.parse(r,t);s.done(a),this.events.emit("load",s),this.checkStatus()}async loadWad(t){const s=new Ks(t);this.wads.push(s),this.events.emit("loadstart",s);const n=(c,u)=>{s.progress=u,this.events.emit("progress",s)},i=this.config.getWadsPath(),r=await be(`${i}/${t}`,{method:"GET",isBinary:!0,progressCallback:n}).catch(c=>{s.error(),this.events.emit("error",c,s),this.checkStatus()});if(s.isError())return;const a=Tt.parse(r);if(s.done(a),!this.map||!this.map.data)return;const o=this.map.data,l=(c,u)=>c.toLowerCase()===u.toLowerCase();for(const c of a.entries){if(c.type!=="texture")return;for(const u of o.textures)l(c.name,u.name)&&(u.width=c.width,u.height=c.height,u.data=c.data)}this.events.emit("load",s),this.checkStatus()}async loadSound(t,s){const n=new Zs(t);this.sounds.push(n),this.events.emit("loadstart",n);const i=(l,c)=>{n.progress=c,this.events.emit("progress",n)},r=this.config.getSoundsPath(),a=await be(`${r}/${t}`,{method:"GET",isBinary:!0,progressCallback:i}).catch(l=>{n.error(),this.events.emit("error",l,n),this.checkStatus()});if(n.isError())return;const o=await Et.create(a).catch(l=>{n.error(),this.events.emit("error",l,n),this.checkStatus()});!o||n.isError()||(o.index=s,o.name=t,n.done(o),this.events.emit("load",n),this.checkStatus())}}class Qs{constructor(){f(this,"click",!1);f(this,"leftClick",!1);f(this,"rightClick",!1);f(this,"position",Ne());f(this,"delta",Ne())}}class en{constructor(){f(this,"pressed",!1);f(this,"position",Ne());f(this,"delta",Ne())}}class It{constructor(t){f(this,"projectionMatrix",At());f(this,"aspect");f(this,"fov",We(87));f(this,"near",1);f(this,"far",16384);f(this,"viewMatrix",At());f(this,"position",ge());f(this,"rotation",ge());this.aspect=t,this.updateProjectionMatrix()}static init(t){return new It(t)}updateProjectionMatrix(){Ds(this.projectionMatrix,this.fov,this.aspect,this.near,this.far)}updateViewMatrix(){xe(this.viewMatrix),Se(this.viewMatrix,this.viewMatrix,this.rotation[0]-Math.PI/2),Q(this.viewMatrix,this.viewMatrix,Math.PI/2-this.rotation[1]),Pe(this.viewMatrix,this.viewMatrix,[-this.position[0],-this.position[1],-this.position[2]])}}class ae{constructor(){f(this,"keys");this.keys=new Uint8Array(256);for(let t=0;t<256;++t)this.keys[0]=0}}(e=>{(t=>{t[t.A=65]="A",t[t.B=66]="B",t[t.C=67]="C",t[t.D=68]="D",t[t.E=69]="E",t[t.F=70]="F",t[t.G=71]="G",t[t.H=72]="H",t[t.I=73]="I",t[t.J=74]="J",t[t.K=75]="K",t[t.L=76]="L",t[t.M=77]="M",t[t.N=78]="N",t[t.O=79]="O",t[t.P=80]="P",t[t.Q=81]="Q",t[t.R=82]="R",t[t.S=83]="S",t[t.T=84]="T",t[t.U=85]="U",t[t.V=86]="V",t[t.W=87]="W",t[t.X=88]="X",t[t.Y=89]="Y",t[t.Z=90]="Z",t[t.CTRL=17]="CTRL",t[t.ALT=18]="ALT",t[t.SPACE=32]="SPACE"})(e.KEYS||(e.KEYS={}))})(ae||(ae={}));class ze{constructor(t){f(this,"gl");this.gl=t}static init(t){const s=t.getContext("webgl",{alpha:!1});return s?new ze(s):(console.error("Failed to get WebGL context"),null)}static checkWebGLSupport(){const t={BAD_BROWSER:"Your browser does not seem to support WebGL",BAD_GPU:"Your graphics card does not seem to support WebGL"};if(!window.WebGLRenderingContext)return{hasSupport:!1,message:t.BAD_BROWSER};const s=document.createElement("canvas");try{return s.getContext("webgl")||s.getContext("experimental-webgl")?{hasSupport:!0,message:""}:{hasSupport:!1,message:t.BAD_GPU}}catch{return{hasSupport:!1,message:t.BAD_GPU}}}createProgram(t){const s=this.gl,n=s.createProgram();if(!n)return console.error("Failed to create WebGL program"),null;const i=this.createShader({source:t.vertexShaderSrc,type:0});if(!i)return console.error("Failed to compile vertex shader"),null;const r=this.createShader({source:t.fragmentShaderSrc,type:1});if(!r)return console.error("Failed to compile fragment shader"),null;if(s.attachShader(n,i),s.attachShader(n,r),s.linkProgram(n),s.validateProgram(n),!s.getProgramParameter(n,s.LINK_STATUS)){s.deleteProgram(n),s.deleteShader(i),s.deleteShader(r);const l=s.getProgramInfoLog(n);return console.error(`Could not initialize shader: ${l}`),null}if(!s.getProgramParameter(n,s.VALIDATE_STATUS)){s.deleteProgram(n),s.deleteShader(i),s.deleteShader(r);const l=s.getProgramInfoLog(n);return console.error(`Could not initialize shader: ${l}`),null}s.useProgram(n);const a={};for(let l=0;l<t.attributeNames.length;++l){const c=t.attributeNames[l],u=s.getAttribLocation(n,c);if(u===-1)return console.error(`gl.getAttribLocation failed for attrib named "${c}"`),s.deleteProgram(n),null;a[c]=u}const o={};for(let l=0;l<t.uniformNames.length;++l){const c=t.uniformNames[l],u=s.getUniformLocation(n,c);if(u===null)return console.error(`gl.getUniformLocation failed for uniform named "${c}"`),s.deleteProgram(n),null;o[c]=u}return{handle:n,attributes:a,uniforms:o}}createShader(t){const s=this.gl,n=t.type===0?s.createShader(s.VERTEX_SHADER):s.createShader(s.FRAGMENT_SHADER);return n?(s.shaderSource(n,t.source),s.compileShader(n),s.getShaderParameter(n,s.COMPILE_STATUS)?n:(console.error(s.getShaderInfoLog(n)),s.deleteShader(n),null)):(console.error("Failed to create shader program"),null)}getAnisotropyExtension(){return this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")}getMaxAnisotropy(t){return this.gl.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}}const _t=(e,t)=>{e.camera.position[0]=t.cameraPos[0],e.camera.position[1]=t.cameraPos[1],e.camera.position[2]=t.cameraPos[2],e.camera.rotation[0]=We(t.cameraRot[0]),e.camera.rotation[1]=We(t.cameraRot[1]),e.camera.rotation[2]=We(t.cameraRot[2])},es=(e,t,s,n)=>{_t(e,t),s.emit("keyspressed",n)};class tn{constructor(t){f(this,"game");f(this,"state");f(this,"replay");f(this,"replayType");f(this,"events");f(this,"currentMap",0);f(this,"currentChunk",0);f(this,"currentTime",0);f(this,"currentTick",0);f(this,"isPlaying",!1);f(this,"isPaused",!1);f(this,"speed",1);this.reset(),this.game=t,this.state=new He,this.replay=null,this.replayType=ye.DEMO,this.events=G()}reset(){if(this.currentMap=0,this.currentChunk=0,this.currentTime=0,this.currentTick=0,this.isPlaying=!1,this.isPaused=!1,this.speed=1,this.replay&&this.replayType==ye.DEMO){const t=this.replay.maps[0].chunks[0];t.reader.seek(0),this.state=t.state.clone()}}changeReplay(t,s){this.replay=t,this.replayType=s,this.reset()}play(){this.isPlaying?this.isPaused&&(this.isPaused=!1):this.isPlaying=!0,this.events.emit("play",this.currentTime)}pause(){this.isPlaying&&(this.isPaused=!0),this.events.emit("pause",this.currentTime)}stop(){this.reset(),this.events.emit("stop",0)}speedUp(){this.speed=Math.min(this.speed*2,4)}speedDown(){this.speed=Math.max(this.speed/2,.25)}seek(t){const s=Math.max(0,Math.min(this.replay.length,t));this.replayType==ye.DEMO?this.seekDemo(s):this.seekHlkz(s)}seekHlkz(t){const s=this.replay.data;let n=0;for(const[i,r]of s.entries())if(r.gametime<=t)this.state.feedHlkzFrame(r);else{this.currentTick=i,this.currentTime=r.gametime,n=r.buttons;break}this.events.emit("seek",t),es(this.game,this.state,this.events,n)}seekDemo(t){const s=this.replay.maps;for(let n=0;n<s.length;++n){const i=s[n].chunks;for(let r=0;r<i.length;++r){const a=i[r],o=a.startTime,l=o+a.timeLength;if(t>=o&&t<l){this.currentMap=n,this.currentChunk=r,this.currentTime=t,this.state=a.state.clone();const c=this.replay.deltaDecoders,u=this.replay.customMessages,h=a.reader;for(h.seek(0);;){const g=h.tell(),d=ke.readFrame(h,c,u);if(d.time<=t)this.state.feedFrame(d),this.currentTick=d.tick;else{h.seek(g);break}}this.events.emit("seek",t),_t(this.game,this.state);return}}}}seekByPercent(t){this.seek(Math.max(0,Math.min(t,100))/100*this.replay.length)}update(t){this.replayType==ye.DEMO?this.updateDemo(t):this.updateHlkz(t)}updateHlkz(t){if(!this.isPlaying||this.isPaused)return;const s=this.replay.data,n=this.currentTime+t*this.speed;let i=0;for(;this.currentTick<s.length;){const r=s[this.currentTick++];if(r.gametime<=n)this.state.feedHlkzFrame(r),this.currentTime=r.gametime,i=r.buttons;else break}es(this.game,this.state,this.events,i),this.currentTime=n,this.currentTick==s.length&&this.stop()}updateDemo(t){if(!this.isPlaying||this.isPaused)return;const s=this.replay.deltaDecoders,n=this.replay.customMessages;let i=this.replay.maps[this.currentMap],r=i.chunks[this.currentChunk],a=r.reader;const o=this.currentTime+t*this.speed;let l=!1;for(;;){let c=a.tell();if(c>=r.data.length){if(this.currentChunk===i.chunks.length-1){if(this.currentMap===this.replay.maps.length-1){l=!0;break}this.currentChunk=0,this.currentMap++,i=this.replay.maps[this.currentMap],r=i.chunks[this.currentChunk]}else this.currentChunk++,r=i.chunks[this.currentChunk];a=r.reader,a.seek(0),c=0;continue}const u=this.game.sounds,h=ke.readFrame(a,s,n);if(h.type<2)for(let g=0;g<h.data.length;++g){const d=h.data[g];if(d.type===6){const m=d.data,p=u.find(E=>E.index===m.soundIndex);if(p&&p.name!=="common/null.wav"){const E=m.channel,T=m.volume;this.game.soundSystem.play(p,E,T)}}else if(d.type===29){const m=d.data,p=u.find(E=>E.index===m.soundIndex);p&&p.name}else if(d.type===9)for(const m of d.data.commands)switch(m.func){case"speak":case"spk":case"play":{const p=`${m.params[0]}.wav`,E=u.find(T=>T.name===p);if(!E)return;this.game.soundSystem.play(E,1,.7);break}case"playvol":{const p=`${m.params[0]}.wav`;let E;Number.isNaN(m.params[1])?E=1:E=Number.parseFloat(m.params[1]);const T=u.find(y=>y.name===p);if(!T)return;this.game.soundSystem.play(T,1,E);break}}}else if(h.type===8){const g=h.sound.sample,d=u.find(m=>m.name===g);if(d&&d.name!=="common/null.wav"){const m=h.sound.channel,p=h.sound.volume;this.game.soundSystem.play(d,m,p)}}if(h.time<=o)this.state.feedFrame(h),this.currentTick=h.tick;else{a.seek(c);break}}_t(this.game,this.state),this.currentTime=o,l&&this.stop()}}class Rt{constructor(t){f(this,"context");f(this,"draw",()=>{const t=this.context.gl;t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)});this.context=t.context}static init(t){const s=t.gl;return s.clearColor(0,0,0,1),s.clearDepth(1),s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL),s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),s.enable(s.CULL_FACE),s.cullFace(s.FRONT),new Rt({context:t})}}const sn=`#ifdef GL_ES
precision highp float;
#endif

uniform sampler2D diffuse;

varying vec2 vTexCoord;

void main(void) {
  vec4 diffuseColor = texture2D(diffuse, vTexCoord);
  gl_FragColor = vec4(diffuseColor.rgb, 1.0);
}`,nn=`#ifdef GL_ES
precision highp float;
#endif

attribute vec3 position;
attribute vec2 texCoord;

varying vec2 vTexCoord;

uniform mat4 viewMatrix;
uniform mat4 projectionMatrix;

void main(void) {
  vTexCoord = texCoord;
  gl_Position = projectionMatrix * viewMatrix * vec4(position, 1);
}`;class Lt{constructor(t){f(this,"program");f(this,"aPosition");f(this,"aTexCoord");f(this,"uViewMx");f(this,"uProjectionMx");f(this,"uDiffuse");this.program=t.handle,this.aPosition=t.attributes.position,this.aTexCoord=t.attributes.texCoord,this.uViewMx=t.uniforms.viewMatrix,this.uProjectionMx=t.uniforms.projectionMatrix,this.uDiffuse=t.uniforms.diffuse}static init(t){const s=["position","texCoord"],n=["viewMatrix","projectionMatrix","diffuse"],i=t.createProgram({vertexShaderSrc:nn,fragmentShaderSrc:sn,attributeNames:s,uniformNames:n});return i?new Lt(i):(console.error("Failed to create sky shader program"),null)}useProgram(t){t.useProgram(this.program)}setViewMatrix(t,s){t.uniformMatrix4fv(this.uViewMx,!1,s)}setProjectionMatrix(t,s){t.uniformMatrix4fv(this.uProjectionMx,!1,s)}setDiffuse(t,s){t.uniform1i(this.uDiffuse,s)}enableVertexAttribs(t){t.enableVertexAttribArray(this.aPosition),t.enableVertexAttribArray(this.aTexCoord)}setVertexAttribPointers(t){t.vertexAttribPointer(this.aPosition,3,t.FLOAT,!1,5*4,0),t.vertexAttribPointer(this.aTexCoord,2,t.FLOAT,!1,5*4,3*4)}}class Pt{constructor(t){f(this,"context");f(this,"shader");f(this,"vertexBuffer",null);f(this,"indexBuffer",null);f(this,"texture",null);f(this,"isReady",!1);this.context=t.context,this.shader=t.shader}static init(t){const s=Lt.init(t);return s?new Pt({context:t,shader:s}):(console.error("skyscenen't"),null)}changeMap(t){if(t.skies.length!==6){this.isReady=!1;return}const s=this.context.gl,n=s.createBuffer(),i=s.createBuffer(),r=s.createTexture();if(!n||!i||!r)throw new Error("shouldnt happen");const a=new Uint8Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),o=new Float32Array([-1,-1,1,.499,.001,1,-1,1,.499,.249,1,1,1,.001,.249,-1,1,1,.001,.001,-1,-1,-1,.499,.749,-1,1,-1,.001,.749,1,1,-1,.001,.501,1,-1,-1,.499,.501,-1,1,-1,.501,.749,-1,1,1,.501,.501,1,1,1,.999,.501,1,1,-1,.999,.749,-1,-1,-1,.999,.249,1,-1,-1,.501,.249,1,-1,1,.501,.001,-1,-1,1,.999,.001,1,-1,-1,.499,.499,1,1,-1,.001,.499,1,1,1,.001,.251,1,-1,1,.499,.251,-1,-1,-1,.501,.499,-1,-1,1,.501,.251,-1,1,1,.999,.251,-1,1,-1,.999,.499].map((d,m)=>m%5<3?d*4096:d));s.bindBuffer(s.ARRAY_BUFFER,n),s.bufferData(s.ARRAY_BUFFER,o,s.STATIC_DRAW),s.enableVertexAttribArray(0),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,i),s.bufferData(s.ELEMENT_ARRAY_BUFFER,a,s.STATIC_DRAW);const l=document.createElement("canvas");l.width=512,l.height=1024;const c=l.getContext("2d");if(!c)throw new Error("sky ctx fail");const u={up:[0,0],rt:[0,256],dn:[0,512],ft:[256,0],lf:[256,256],bk:[256,512]};for(const d of t.skies){const m=document.createElement("canvas"),p=m.getContext("2d");if(!p)throw new Error("Runtime error.");m.width=d.width,m.height=d.height;const E=p.getImageData(0,0,m.width,m.height);for(let k=0;k<d.data.length;++k)E.data[k]=d.data[k];p.putImageData(E,0,0);const T=d.name.slice(-2),y=u[T]?u[T]:[];if(!c)throw new Error("Runtime error.");c.drawImage(m,y[0],y[1])}const h=c.getImageData(0,0,512,1024).data;s.bindTexture(s.TEXTURE_2D,r),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,512,1024,0,s.RGBA,s.UNSIGNED_BYTE,new Uint8Array(h)),s.generateMipmap(s.TEXTURE_2D),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.REPEAT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.REPEAT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_LINEAR),s.texParameterf(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR);const g=this.context.getAnisotropyExtension();g&&s.texParameteri(s.TEXTURE_2D,g.TEXTURE_MAX_ANISOTROPY_EXT,this.context.getMaxAnisotropy(g)),this.vertexBuffer=n,this.indexBuffer=i,this.texture=r,this.isReady=!0}draw(t){if(!this.isReady)return;const s=this.context.gl,n=this.shader;n.useProgram(s),s.bindTexture(s.TEXTURE_2D,this.texture),s.bindBuffer(s.ARRAY_BUFFER,this.vertexBuffer),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this.indexBuffer),n.enableVertexAttribs(s),n.setVertexAttribPointers(s),n.setDiffuse(s,0);const i=t.position[0],r=t.position[1],a=t.position[2];t.position[0]=0,t.position[1]=0,t.position[2]=0,t.updateViewMatrix(),t.position[0]=i,t.position[1]=r,t.position[2]=a,n.setViewMatrix(s,t.viewMatrix),n.setProjectionMatrix(s,t.projectionMatrix),s.drawElements(s.TRIANGLES,36,s.UNSIGNED_BYTE,0),s.clear(s.DEPTH_BUFFER_BIT)}}const rn=`#ifdef GL_ES
precision highp float;
#endif

uniform sampler2D diffuse;
uniform sampler2D lightmap;
uniform float opacity;

varying vec2 vTexCoord;
varying vec2 vLightmapCoord;

void main(void) {
  vec4 diffuseColor = texture2D(diffuse, vTexCoord);
  vec4 lightColor = texture2D(lightmap, vLightmapCoord);

  // gl_FragColor = vec4(diffuseColor.rgb * lightColor.rgb, diffuseColor.a * opacity);
  gl_FragColor = vec4(pow(diffuseColor.rgb * lightColor.rgb, vec3(0.85)), diffuseColor.a * opacity);
}`,on=`#ifdef GL_ES
precision highp float;
#endif

attribute vec3 position;
attribute vec2 texCoord;
attribute vec2 texCoord2;

varying vec2 vTexCoord;
varying vec2 vLightmapCoord;

uniform mat4 modelMatrix;
uniform mat4 viewMatrix;
uniform mat4 projectionMatrix;

void main(void) {
  vTexCoord = texCoord;
  vLightmapCoord = texCoord2;

  gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1);
}`;class St{constructor(t){f(this,"program");f(this,"aPosition");f(this,"aTexCoord");f(this,"aTexCoord2");f(this,"uModelMx");f(this,"uViewMx");f(this,"uProjectionMx");f(this,"uDiffuse");f(this,"uLightmap");f(this,"uOpacity");this.program=t.handle,this.aPosition=t.attributes.position,this.aTexCoord=t.attributes.texCoord,this.aTexCoord2=t.attributes.texCoord2,this.uModelMx=t.uniforms.modelMatrix,this.uViewMx=t.uniforms.viewMatrix,this.uProjectionMx=t.uniforms.projectionMatrix,this.uDiffuse=t.uniforms.diffuse,this.uLightmap=t.uniforms.lightmap,this.uOpacity=t.uniforms.opacity}static init(t){const s=["position","texCoord","texCoord2"],n=["modelMatrix","viewMatrix","projectionMatrix","diffuse","lightmap","opacity"],i=t.createProgram({vertexShaderSrc:on,fragmentShaderSrc:rn,attributeNames:s,uniformNames:n});return i?new St(i):(console.error("Failed to create MainShader program"),null)}useProgram(t){t.useProgram(this.program)}setModelMatrix(t,s){t.uniformMatrix4fv(this.uModelMx,!1,s)}setViewMatrix(t,s){t.uniformMatrix4fv(this.uViewMx,!1,s)}setProjectionMatrix(t,s){t.uniformMatrix4fv(this.uProjectionMx,!1,s)}setDiffuse(t,s){t.uniform1i(this.uDiffuse,s)}setLightmap(t,s){t.uniform1i(this.uLightmap,s)}setOpacity(t,s){t.uniform1f(this.uOpacity,s)}enableVertexAttribs(t){t.enableVertexAttribArray(this.aPosition),t.enableVertexAttribArray(this.aTexCoord),t.enableVertexAttribArray(this.aTexCoord2)}setVertexAttribPointers(t){t.vertexAttribPointer(this.aPosition,3,t.FLOAT,!1,7*4,0),t.vertexAttribPointer(this.aTexCoord,2,t.FLOAT,!1,7*4,3*4),t.vertexAttribPointer(this.aTexCoord2,2,t.FLOAT,!1,7*4,5*4)}}var R=(e=>(e[e.Normal=0]="Normal",e[e.Color=1]="Color",e[e.Texture=2]="Texture",e[e.Glow=3]="Glow",e[e.Solid=4]="Solid",e[e.Additive=5]="Additive",e))(R||{});const ts=(e,t,s,n,i)=>{const r=document.createElement("canvas"),a=r.getContext("2d");if(!a)throw new Error("Runtime error.");r.width=t,r.height=s;const o=document.createElement("canvas"),l=o.getContext("2d");if(!l)throw new Error("Runtime error.");o.width=n,o.height=i;const c=a.createImageData(t,s);for(let u=0,h=t*s*4;u<h;u+=4)c.data[u]=e[u],c.data[u+1]=e[u+1],c.data[u+2]=e[u+2],c.data[u+3]=e[u+3];return a.putImageData(c,0,0),l.drawImage(r,0,0,n,i),new Uint8Array(l.getImageData(0,0,n,i).data)},qe=e=>(e&e-1)===0,Ve=e=>{let t=e;--t;for(let s=1;s<32;s<<=1)t=t|t>>s;return t+1};class Nt{constructor(t){f(this,"buffer");f(this,"context");f(this,"shader");f(this,"modelMatrix",At());f(this,"sceneInfo",{length:0,data:new Float32Array(0),models:[]});f(this,"bsp",null);f(this,"textures",[]);f(this,"sprites",{});f(this,"lightmap",null);this.buffer=t.buffer,this.context=t.context,this.shader=t.shader}static init(t){const s=St.init(t);if(!s)return console.error("Failed to init MainShader"),null;s.useProgram(t.gl);const n=t.gl.createBuffer();return n?new Nt({buffer:n,context:t,shader:s}):(console.error("Failed to create WebGL buffer"),null)}changeMap(t){this.fillBuffer(t),this.loadTextures(t),this.loadSpriteTextures(t),this.loadLightmap(t),this.bsp=t}fillBuffer(t){const s=this.context.gl,n=t.models,i=["aaatrigger","clip","null","hint","nodraw","invisible","skip","trigger","fog"];let r=0;for(let c=0;c<n.length;++c){const u=n[c];for(let h=0;h<u.faces.length;++h){const g=t.textures[u.faces[h].textureIndex];i.indexOf(g.name)>-1||(r+=u.faces[h].buffer.length)}}r+=7*6;const a={length:r,data:new Float32Array(r),models:[]};let o=0;for(let c=0;c<t.models.length;++c){const u=t.models[c],h={origin:u.origin,offset:o,length:0,isTransparent:!1,faces:[]};for(let g=0;g<u.faces.length;++g){const d=t.textures[u.faces[g].textureIndex];if(i.indexOf(d.name)>-1)continue;const m={offset:o,length:0,textureIndex:-1};for(let p=0;p<u.faces[g].buffer.length;++p)a.data[o++]=u.faces[g].buffer[p];!h.isTransparent&&t.textures[u.faces[g].textureIndex].name[0]==="{"&&(h.isTransparent=!0),m.textureIndex=u.faces[g].textureIndex,m.length=o-m.offset,h.faces.push(m)}h.length=o-h.offset,a.models.push(h)}a.models.push({origin:[0,0,0],offset:o,length:4,isTransparent:!1,faces:[{offset:o,length:4,textureIndex:0}]}),a.data[o++]=-.5,a.data[o++]=0,a.data[o++]=-.5,a.data[o++]=1,a.data[o++]=1,a.data[o++]=0,a.data[o++]=0,a.data[o++]=.5,a.data[o++]=0,a.data[o++]=.5,a.data[o++]=0,a.data[o++]=0,a.data[o++]=0,a.data[o++]=0,a.data[o++]=-.5,a.data[o++]=0,a.data[o++]=.5,a.data[o++]=1,a.data[o++]=0,a.data[o++]=0,a.data[o++]=0,a.data[o++]=-.5,a.data[o++]=0,a.data[o++]=-.5,a.data[o++]=1,a.data[o++]=1,a.data[o++]=0,a.data[o++]=0,a.data[o++]=.5,a.data[o++]=0,a.data[o++]=-.5,a.data[o++]=0,a.data[o++]=1,a.data[o++]=0,a.data[o++]=0,a.data[o++]=.5,a.data[o++]=0,a.data[o++]=.5,a.data[o++]=0,a.data[o++]=0,a.data[o++]=0,a.data[o++]=0,o=0;const l={data:new Float32Array(a.data),length:a.length,models:a.models.map(c=>({origin:Us(c.origin),offset:c.offset,length:c.length,isTransparent:c.isTransparent,faces:c.faces.map(u=>({offset:u.offset,length:u.length,textureIndex:u.textureIndex}))}))};for(let c=0;c<l.models.length;++c){const u=l.models[c];u.faces.sort((d,m)=>d.textureIndex-m.textureIndex);for(let d=0;d<u.faces.length;++d){const m=u.faces[d],p=o;for(let E=0;E<m.length;++E)l.data[o]=a.data[m.offset+E],o+=1;m.offset=p}const h=[];let g=-1;for(let d=0;d<u.faces.length;++d){const m=u.faces[d];m.textureIndex===g?h[h.length-1].length+=m.length:(h.push({offset:m.offset,length:m.length,textureIndex:m.textureIndex}),g=m.textureIndex)}u.faces=h}this.sceneInfo=l,s.bindBuffer(s.ARRAY_BUFFER,this.buffer),s.bufferData(s.ARRAY_BUFFER,this.sceneInfo.data,s.STATIC_DRAW)}loadTextures(t){const s=this.context.gl;for(let n=0;n<t.textures.length;++n){const i=s.createTexture();if(!i)throw new Error("fatal error");const r=t.textures[n];if(!qe(r.width)||!qe(r.height)){const o=r.width,l=r.height,c=Ve(r.width),u=Ve(r.height);r.data=ts(r.data,o,l,c,u),r.width=c,r.height=u}s.bindTexture(s.TEXTURE_2D,i),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,r.width,r.height,0,s.RGBA,s.UNSIGNED_BYTE,r.data),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.REPEAT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.REPEAT),s.generateMipmap(s.TEXTURE_2D);const a=this.context.getAnisotropyExtension();a&&s.texParameteri(s.TEXTURE_2D,a.TEXTURE_MAX_ANISOTROPY_EXT,this.context.getMaxAnisotropy(a)),this.textures.push({name:r.name,width:r.width,height:r.height,data:r.data,handle:i})}}loadSpriteTextures(t){const s=this.context.gl;for(const[n,i]of Object.entries(t.sprites)){const r=s.createTexture();if(!r)throw new Error("fatal error");const a=i.frames[0];if(!qe(a.width)||!qe(a.height)){const l=a.width,c=a.height,u=Ve(a.width),h=Ve(a.height);a.data=ts(a.data,l,c,u,h),a.width=u,a.height=h}s.bindTexture(s.TEXTURE_2D,r),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,a.width,a.height,0,s.RGBA,s.UNSIGNED_BYTE,a.data),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.REPEAT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.REPEAT),s.generateMipmap(s.TEXTURE_2D);const o=this.context.getAnisotropyExtension();o&&s.texParameteri(s.TEXTURE_2D,o.TEXTURE_MAX_ANISOTROPY_EXT,this.context.getMaxAnisotropy(o)),this.textures.push({name:n,width:a.width,height:a.height,data:a.data,handle:r}),this.sprites[n]=i}}loadLightmap(t){const s=this.context.gl,n=s.createTexture();if(!n)throw new Error("fatal error");s.bindTexture(s.TEXTURE_2D,n),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,t.lightmap.width,t.lightmap.height,0,s.RGBA,s.UNSIGNED_BYTE,t.lightmap.data),s.generateMipmap(s.TEXTURE_2D),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_LINEAR),this.lightmap={data:t.lightmap.data,handle:n}}draw(t,s){if(!this.bsp||!this.lightmap)return;const n=this.context.gl,i=this.shader;i.useProgram(n),t.updateProjectionMatrix(),t.updateViewMatrix(),i.setViewMatrix(n,t.viewMatrix),i.setProjectionMatrix(n,t.projectionMatrix),n.bindBuffer(n.ARRAY_BUFFER,this.buffer),i.enableVertexAttribs(n),i.setVertexAttribPointers(n),i.setDiffuse(n,0),i.setLightmap(n,1),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,this.lightmap.handle),n.activeTexture(n.TEXTURE0);const r=s.filter(l=>!l.classname.startsWith("trigger_")),a=[],o=[];for(const l of r)if(l.model)if(!l.rendermode||l.rendermode===R.Normal||l.rendermode===R.Solid){if(l.model[0]==="*"){if(this.sceneInfo.models[Number.parseInt(l.model.substr(1))].isTransparent){o.push(l);continue}}else if(l.model.indexOf(".spr")>-1){o.push(l);continue}a.push(l)}else l.rendermode,R.Additive,o.push(l);i.setOpacity(n,1),this.renderWorldSpawn(),this.renderOpaqueEntities(t,a),o.length&&(n.depthMask(!1),this.renderTransparentEntities(o,t),n.depthMask(!0))}drawModel(t,s){for(let n=0;n<s.faces.length;++n){const i=s.faces[n],r=this.textures[i.textureIndex];if(r.name==="sky"){t.colorMask(!1,!1,!1,!1);const a=t.getParameter(t.DEPTH_WRITEMASK);t.depthMask(!0),t.bindTexture(t.TEXTURE_2D,r.handle),t.drawArrays(t.TRIANGLES,i.offset/7,i.length/7),t.colorMask(!0,!0,!0,!0),t.depthMask(a)}else t.bindTexture(t.TEXTURE_2D,r.handle),t.drawArrays(t.TRIANGLES,i.offset/7,i.length/7)}}drawEntityModel(t,s){if(s.name==="sky"){t.colorMask(!1,!1,!1,!1);const n=t.getParameter(t.DEPTH_WRITEMASK);t.depthMask(!0),t.bindTexture(t.TEXTURE_2D,s.handle),t.drawArrays(t.TRIANGLES,this.sceneInfo.models[this.sceneInfo.models.length-1].offset/7,6),t.colorMask(!0,!0,!0,!0),t.depthMask(n)}else t.bindTexture(t.TEXTURE_2D,s.handle),t.drawArrays(t.TRIANGLES,this.sceneInfo.models[this.sceneInfo.models.length-1].offset/7,6)}renderWorldSpawn(){const t=this.sceneInfo.models[0],s=this.context.gl;xe(this.modelMatrix),this.shader.setModelMatrix(s,this.modelMatrix),this.drawModel(s,t)}renderOpaqueEntities(t,s){const n=this.context.gl,i=this.shader,r=this.modelMatrix;for(let a=0;a<s.length;++a){const o=s[a],l=Number.parseInt(o.model.substr(1)),c=this.sceneInfo.models[l];if(c){const u=o.origin?oe(o.origin[0],o.origin[1],o.origin[2]):ge();Fs(u,u,c.origin),xe(r),Pe(r,r,u),i.setModelMatrix(n,r),this.drawModel(n,c)}else if(o.model.indexOf(".spr")>-1){const u=this.textures.find(g=>g.name===o.model),h=this.sprites[o.model];if(u&&h){const g=o.origin?oe(o.origin[0],o.origin[1],o.origin[2]):ge(),d=oe(u.width,1,u.height),m=o.angles?oe(o.angles[0],o.angles[2],o.angles[1]):ge();switch(Qt(d,d,o.scale||1),xe(r),Pe(r,r,g),h.header.type){case J.VP_PARALLEL_UPRIGHT:{Q(r,r,t.rotation[1]+Math.PI/2);break}case J.FACING_UPRIGHT:{Q(r,r,t.rotation[1]+Math.PI/2);break}case J.VP_PARALLEL:{Q(r,r,Math.atan2(g[1]-t.position[1],g[0]-t.position[0])+Math.PI/2),Se(r,r,Math.atan2(t.position[2]-g[2],Math.sqrt((t.position[0]-g[0])**2+(t.position[1]-g[1])**2)));break}case J.ORIENTED:{je(r,r,m[0]*Math.PI/180+Math.PI),Q(r,r,m[1]*Math.PI/180+Math.PI),Se(r,r,m[2]*Math.PI/180-Math.PI/2);break}case J.VP_PARALLEL_ORIENTED:{je(r,r,m[0]*Math.PI/180+Math.PI),Q(r,r,m[1]*Math.PI/180+Math.PI);break}default:throw new Error("Invalid sprite type")}switch(Jt(r,r,d),i.setModelMatrix(n,r),i.setOpacity(n,(o.renderamt||255)/255),o.rendermode||R.Normal){case R.Normal:{i.setOpacity(n,1),this.drawEntityModel(n,u);break}case R.Color:case R.Texture:case R.Solid:{i.setOpacity(n,(o.renderamt||255)/255),this.drawEntityModel(n,u);break}case R.Glow:case R.Additive:{n.blendFunc(n.SRC_ALPHA,n.DST_ALPHA),i.setOpacity(n,(o.renderamt||255)/255),this.drawEntityModel(n,u),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA);break}}}}}}renderTransparentEntities(t,s){const n=this.context.gl,i=this.shader,r=this.modelMatrix,a=t.map((o,l)=>({index:l,distance:$s(s.position,o.origin||[0,0,0])})).sort((o,l)=>o.distance-l.distance);for(let o=0;o<a.length;++o){const l=t[a[o].index],c=Number.parseInt(l.model.substr(1)),u=this.sceneInfo.models[c];if(u){const h=l.origin||[0,0,0];switch(h[0]+=u.origin[0],h[1]+=u.origin[1],h[2]+=u.origin[2],xe(r),Pe(r,r,h),i.setModelMatrix(n,r),l.rendermode||R.Normal){case R.Normal:{i.setOpacity(n,1),this.drawModel(n,u);break}case R.Color:case R.Texture:case R.Glow:case R.Solid:{i.setOpacity(n,(l.renderamt||255)/255),this.drawModel(n,u);break}case R.Additive:{n.blendFunc(n.SRC_ALPHA,n.DST_ALPHA),i.setOpacity(n,(l.renderamt||255)/255),this.drawModel(n,u),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA);break}}}else if(l.model.indexOf(".spr")>-1){const h=this.textures.find(d=>d.name===l.model),g=this.sprites[l.model];if(h&&g){const d=l.origin?oe(l.origin[0],l.origin[1],l.origin[2]):ge(),m=oe(h.width,1,h.height),p=l.angles?oe(l.angles[0],l.angles[2],l.angles[1]):ge();switch(Qt(m,m,l.scale||1),xe(r),Pe(r,r,d),g.header.type){case J.VP_PARALLEL_UPRIGHT:{Q(r,r,s.rotation[1]+Math.PI/2);break}case J.FACING_UPRIGHT:{Q(r,r,s.rotation[1]+Math.PI/2);break}case J.VP_PARALLEL:{Q(r,r,Math.atan2(d[1]-s.position[1],d[0]-s.position[0])+Math.PI/2),Se(r,r,Math.atan2(s.position[2]-d[2],Math.sqrt((s.position[0]-d[0])**2+(s.position[1]-d[1])**2)));break}case J.ORIENTED:{je(r,r,p[0]*Math.PI/180+Math.PI),Q(r,r,p[1]*Math.PI/180+Math.PI),Se(r,r,p[2]*Math.PI/180-Math.PI/2);break}case J.VP_PARALLEL_ORIENTED:{je(r,r,p[0]*Math.PI/180+Math.PI),Q(r,r,p[1]*Math.PI/180+Math.PI);break}default:throw new Error("Invalid sprite type")}switch(Jt(r,r,m),i.setModelMatrix(n,r),i.setOpacity(n,(l.renderamt||255)/255),l.rendermode||R.Normal){case R.Normal:{i.setOpacity(n,1),this.drawEntityModel(n,h);break}case R.Color:case R.Texture:case R.Solid:{i.setOpacity(n,(l.renderamt||255)/255),this.drawEntityModel(n,h);break}case R.Glow:case R.Additive:{n.blendFunc(n.SRC_ALPHA,n.DST_ALPHA),i.setOpacity(n,(l.renderamt||255)/255),this.drawEntityModel(n,h),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA);break}}}}}}}var j=(e=>(e[e.FREE=0]="FREE",e[e.REPLAY=1]="REPLAY",e))(j||{});class Ot{constructor(t){f(this,"config");f(this,"pauseTime",0);f(this,"isPaused",!1);f(this,"lastTime",0);f(this,"accumTime",0);f(this,"timeStep",1/60);f(this,"title","");f(this,"mode");f(this,"pointerLocked",!1);f(this,"showKeys",!0);f(this,"touch",new en);f(this,"mouse",new Qs);f(this,"keyboard",new ae);f(this,"loader");f(this,"entities",[]);f(this,"sounds");f(this,"soundSystem");f(this,"events");f(this,"player");f(this,"canvas");f(this,"mapName");f(this,"context");f(this,"camera");f(this,"renderer");f(this,"worldScene");f(this,"skyScene");f(this,"onLoadAll",t=>{if(t!=null&&t.replay&&(this.changeReplay(t.replay.data,t.replayType),this.changeMode(1)),!t.map||!t.map.data)return;const s=t.map.data,n=t.skies;let i=!0;for(const r of n)i=i&&r.isDone();if(i)for(const r of n)r.data&&s.skies.push(r.data);for(const[r,a]of Object.entries(t.sprites))a.data&&(s.sprites[r]=a.data);if(t.sounds.length>0)for(const r of t.sounds)r.data&&this.sounds.push(r.data);this.changeMap(s),this.events.emit("load",t)});f(this,"draw",()=>{requestAnimationFrame(this.draw);const t=this.canvas,s=t.parentElement;if(s){const r=s.clientWidth,a=s.clientHeight;(t.width!==r||t.height!==a)&&(t.width=r,t.height=a,this.camera.aspect=t.clientWidth/t.clientHeight,this.camera.updateProjectionMatrix(),this.context.gl.viewport(0,0,this.context.gl.drawingBufferWidth,this.context.gl.drawingBufferHeight)),(t.clientWidth!==t.width||t.clientHeight!==t.height)&&(t.width=t.clientWidth,t.height=t.clientHeight,this.camera.aspect=t.clientWidth/t.clientHeight,this.camera.updateProjectionMatrix(),this.context.gl.viewport(0,0,this.context.gl.drawingBufferWidth,this.context.gl.drawingBufferHeight))}if(this.isPaused)return;const n=fe()/1e3,i=n-this.lastTime;for(this.accumTime+=i;this.accumTime>this.timeStep;)this.update(this.timeStep),this.accumTime-=this.timeStep;this.renderer.draw(),this.mapName!==""&&(this.skyScene.draw(this.camera),this.worldScene.draw(this.camera,this.entities)),this.lastTime=n});f(this,"onTouchStart",t=>{const s=t.touches.item(0);s&&(this.touch.pressed=!0,this.touch.position[0]=s.clientX,this.touch.position[1]=s.clientY)});f(this,"onTouchEnd",()=>{this.touch.pressed=!1,this.touch.delta[0]=0,this.touch.delta[1]=0});f(this,"onTouchMove",t=>{const s=t.touches.item(0);s&&this.touch.pressed&&(this.touch.delta[0],this.touch.delta[0]=s.clientX-this.touch.position[0],this.touch.delta[1]=s.clientY-this.touch.position[1],this.touch.position[0]=s.clientX,this.touch.position[1]=s.clientY)});f(this,"onMouseMove",t=>{this.pointerLocked&&(this.mouse.delta[0]=t.movementX,this.mouse.delta[1]=t.movementY,this.mouse.position[0]=t.pageX,this.mouse.position[1]=t.pageY)});f(this,"keyDown",t=>(this.keyboard.keys[t.which]=1,this.pointerLocked?(t.preventDefault(),!1):!0));f(this,"keyUp",t=>(this.keyboard.keys[t.which]=0,this.pointerLocked?(t.preventDefault(),!1):!0));f(this,"onVisibilityChange",()=>{if(document.hidden){if(this.isPaused)return;this.pauseTime=fe()/1e3,this.isPaused=!0}else{if(!this.isPaused)return;this.lastTime=fe()/1e3-this.pauseTime+this.lastTime,this.isPaused=!1}});this.sounds=[],this.soundSystem=new zt,this.config=t.config,this.loader=new Js(this.config),this.loader.events.on("loadall",this.onLoadAll),document.addEventListener("touchstart",this.onTouchStart,!1),document.addEventListener("touchend",this.onTouchEnd,!1),document.addEventListener("touchcancel",this.onTouchEnd,!1),document.addEventListener("touchmove",this.onTouchMove,!1),document.addEventListener("mousemove",this.onMouseMove,!1),window.addEventListener("keydown",this.keyDown),window.addEventListener("keyup",this.keyUp),window.addEventListener("visibilitychange",this.onVisibilityChange),this.canvas=t.canvas,this.camera=It.init(this.canvas.width/this.canvas.height),this.context=t.context,this.renderer=t.renderer,this.worldScene=t.worldScene,this.skyScene=t.skyScene,this.mode=0,this.player=new tn(this),this.events=G(),this.mapName=""}static init(t){if(!ze.checkWebGLSupport().hasSupport)return{status:"error",message:"No WebGL support!"};const n=document.createElement("canvas");if(!n)return{status:"error",message:"Failed to create <canvas> element!"};const i=ze.init(n);if(!i)return{status:"error",message:"Failed to initialize WebGL context"};const r=Rt.init(i);if(!r)return{status:"error",message:"Failed to initialize renderer"};const a=Nt.init(i);if(!a)return{status:"error",message:"Failed to initialize world scene"};const o=Pt.init(i);return o?{status:"success",game:new Ot({canvas:n,config:t,context:i,renderer:r,worldScene:a,skyScene:o})}:{status:"error",message:"Failed to initialize sky scene"}}getCanvas(){return this.canvas}load(t){this.events.emit("loadstart"),this.loader.load(t)}changeMap(t){if(this.mapName.toLowerCase()===t.name.toLowerCase())return;this.mapName=t.name,this.worldScene.changeMap(t),this.skyScene.changeMap(t),this.entities=t.entities;const s=t.entities.find(n=>n.classname==="info_player_start");s?(this.camera.position[0]=s.origin[0],this.camera.position[1]=s.origin[1],this.camera.position[2]=s.origin[2]):(this.camera.position[0]=0,this.camera.position[1]=0,this.camera.position[2]=0),this.camera.rotation[0]=0,this.camera.rotation[1]=0,this.camera.rotation[2]=0}changeReplay(t,s){this.events.emit("prereplaychange",this,t),this.player.changeReplay(t,s),this.events.emit("postreplaychange",this,t)}changeMode(t){this.mode=t,this.events.emit("modechange",t)}setTitle(t){this.title=t,this.events.emit("titlechange",t)}getTitle(){return this.title}changeShowKeys(){this.showKeys=!this.showKeys,this.events.emit("showkeyschange",this.showKeys)}update(t){this.events.emit("preupdate",this);const s=this.camera,n=this.keyboard,i=this.mouse,r=this.touch;if(this.mode===1)this.player.update(t);else if(this.mode===0){this.touch.pressed?(s.rotation[0]=Math.min(Math.max(s.rotation[0]+r.delta[1]/100,-Math.PI/2),Math.PI/2),s.rotation[1]-=r.delta[0]/100):(s.rotation[0]=Math.min(Math.max(s.rotation[0]+i.delta[1]/100,-Math.PI/2),Math.PI/2),s.rotation[1]-=i.delta[0]/100);const o=500*t,l=ae.KEYS.W,c=ae.KEYS.S,u=ae.KEYS.A,h=ae.KEYS.D,g=ae.KEYS.C,d=ae.KEYS.SPACE;if(n.keys[l]!==n.keys[c]){const m=s.rotation[1],p=s.rotation[0];n.keys[l]?(s.position[0]+=Math.cos(m)*Math.cos(p)*o,s.position[1]+=Math.sin(m)*Math.cos(p)*o,s.position[2]-=Math.sin(p)*o):n.keys[c]&&(s.position[0]-=Math.cos(m)*Math.cos(p)*o,s.position[1]-=Math.sin(m)*Math.cos(p)*o,s.position[2]+=Math.sin(p)*o)}n.keys[u]!==n.keys[h]&&(n.keys[u]?(s.position[1]+=Math.cos(s.rotation[1])*o,s.position[0]-=Math.sin(s.rotation[1])*o):n.keys[h]&&(s.position[1]-=Math.cos(s.rotation[1])*o,s.position[0]+=Math.sin(s.rotation[1])*o)),n.keys[d]!==n.keys[g]&&(n.keys[d]?s.position[2]+=o:n.keys[g]&&(s.position[2]-=o))}i.delta[0]=0,i.delta[1]=0,this.events.emit("postupdate",this)}}class Ke{constructor(t){f(this,"paths");this.paths={...t.paths}}static init(t){var s,n,i,r,a,o;return typeof t=="string"?new Ke({paths:{base:t,replays:`${t}/replays`,maps:`${t}/maps`,wads:`${t}/wads`,skies:`${t}/skies`,sounds:`${t}/sounds`}}):new Ke({paths:{base:((s=t==null?void 0:t.paths)==null?void 0:s.base)||"",replays:((n=t==null?void 0:t.paths)==null?void 0:n.replays)||"/replays",maps:((i=t==null?void 0:t.paths)==null?void 0:i.maps)||"/maps",wads:((r=t==null?void 0:t.paths)==null?void 0:r.wads)||"/wads",skies:((a=t==null?void 0:t.paths)==null?void 0:a.skies)||"/skies",sounds:((o=t==null?void 0:t.paths)==null?void 0:o.sounds)||"/sounds"}})}getBasePath(){return this.paths.base}getReplaysPath(){return this.paths.replays}getMapsPath(){return this.paths.maps}getWadsPath(){return this.paths.wads}getSkiesPath(){return this.paths.skies}getSoundsPath(){return this.paths.sounds}}const an=!1,ln=(e,t)=>e===t,we=Symbol("solid-proxy"),Bt=Symbol("solid-track"),Ze={equals:ln};let ss=os;const pe=1,Ye=2,ns={owned:null,cleanups:null,context:null,owner:null};var P=null;let Dt=null,cn=null,B=null,H=null,le=null,Je=0;function Qe(e,t){const s=B,n=P,i=e.length===0,r=t===void 0?n:t,a=i?ns:{owned:null,cleanups:null,context:r?r.context:null,owner:r},o=i?e:()=>e(()=>ce(()=>Ue(a)));P=a,B=null;try{return Ie(o,!0)}finally{B=s,P=n}}function V(e,t){t=t?Object.assign({},Ze,t):Ze;const s={value:e,observers:null,observerSlots:null,comparator:t.equals||void 0},n=i=>(typeof i=="function"&&(i=i(s.value)),rs(s,i));return[is.bind(s),n]}function K(e,t,s){const n=Ft(e,t,!1,pe);De(n)}function un(e,t,s){ss=En;const n=Ft(e,t,!1,pe);n.user=!0,le?le.push(n):De(n)}function se(e,t,s){s=s?Object.assign({},Ze,s):Ze;const n=Ft(e,t,!0,0);return n.observers=null,n.observerSlots=null,n.comparator=s.equals||void 0,De(n),is.bind(n)}function hn(e){return Ie(e,!1)}function ce(e){if(B===null)return e();const t=B;B=null;try{return e()}finally{B=t}}function Be(e){un(()=>ce(e))}function Me(e){return P===null||(P.cleanups===null?P.cleanups=[e]:P.cleanups.push(e)),e}function Ut(){return B}function fn(e,t){const s=Symbol("context");return{id:s,Provider:Tn(s),defaultValue:e}}function dn(e){let t;return P&&P.context&&(t=P.context[e.id])!==void 0?t:e.defaultValue}function mn(e){const t=se(e),s=se(()=>Ct(t()));return s.toArray=()=>{const n=s();return Array.isArray(n)?n:n!=null?[n]:[]},s}function is(){if(this.sources&&this.state)if(this.state===pe)De(this);else{const e=H;H=null,Ie(()=>tt(this),!1),H=e}if(B){const e=this.observers?this.observers.length:0;B.sources?(B.sources.push(this),B.sourceSlots.push(e)):(B.sources=[this],B.sourceSlots=[e]),this.observers?(this.observers.push(B),this.observerSlots.push(B.sources.length-1)):(this.observers=[B],this.observerSlots=[B.sources.length-1])}return this.value}function rs(e,t,s){let n=e.value;return(!e.comparator||!e.comparator(n,t))&&(e.value=t,e.observers&&e.observers.length&&Ie(()=>{for(let i=0;i<e.observers.length;i+=1){const r=e.observers[i],a=Dt&&Dt.running;a&&Dt.disposed.has(r),(a?!r.tState:!r.state)&&(r.pure?H.push(r):le.push(r),r.observers&&as(r)),a||(r.state=pe)}if(H.length>1e6)throw H=[],new Error},!1)),t}function De(e){if(!e.fn)return;Ue(e);const t=Je;gn(e,e.value,t)}function gn(e,t,s){let n;const i=P,r=B;B=P=e;try{n=e.fn(t)}catch(a){return e.pure&&(e.state=pe,e.owned&&e.owned.forEach(Ue),e.owned=null),e.updatedAt=s+1,ls(a)}finally{B=r,P=i}(!e.updatedAt||e.updatedAt<=s)&&(e.updatedAt!=null&&"observers"in e?rs(e,n):e.value=n,e.updatedAt=s)}function Ft(e,t,s,n=pe,i){const r={fn:e,state:n,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:P,context:P?P.context:null,pure:s};return P===null||P!==ns&&(P.owned?P.owned.push(r):P.owned=[r]),r}function et(e){if(e.state===0)return;if(e.state===Ye)return tt(e);if(e.suspense&&ce(e.suspense.inFallback))return e.suspense.effects.push(e);const t=[e];for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<Je);)e.state&&t.push(e);for(let s=t.length-1;s>=0;s--)if(e=t[s],e.state===pe)De(e);else if(e.state===Ye){const n=H;H=null,Ie(()=>tt(e,t[0]),!1),H=n}}function Ie(e,t){if(H)return e();let s=!1;t||(H=[]),le?s=!0:le=[],Je++;try{const n=e();return pn(s),n}catch(n){s||(le=null),H=null,ls(n)}}function pn(e){if(H&&(os(H),H=null),e)return;const t=le;le=null,t.length&&Ie(()=>ss(t),!1)}function os(e){for(let t=0;t<e.length;t++)et(e[t])}function En(e){let t,s=0;for(t=0;t<e.length;t++){const n=e[t];n.user?e[s++]=n:et(n)}for(t=0;t<s;t++)et(e[t])}function tt(e,t){e.state=0;for(let s=0;s<e.sources.length;s+=1){const n=e.sources[s];if(n.sources){const i=n.state;i===pe?n!==t&&(!n.updatedAt||n.updatedAt<Je)&&et(n):i===Ye&&tt(n,t)}}}function as(e){for(let t=0;t<e.observers.length;t+=1){const s=e.observers[t];s.state||(s.state=Ye,s.pure?H.push(s):le.push(s),s.observers&&as(s))}}function Ue(e){let t;if(e.sources)for(;e.sources.length;){const s=e.sources.pop(),n=e.sourceSlots.pop(),i=s.observers;if(i&&i.length){const r=i.pop(),a=s.observerSlots.pop();n<i.length&&(r.sourceSlots[a]=n,i[n]=r,s.observerSlots[n]=a)}}if(e.tOwned){for(t=e.tOwned.length-1;t>=0;t--)Ue(e.tOwned[t]);delete e.tOwned}if(e.owned){for(t=e.owned.length-1;t>=0;t--)Ue(e.owned[t]);e.owned=null}if(e.cleanups){for(t=e.cleanups.length-1;t>=0;t--)e.cleanups[t]();e.cleanups=null}e.state=0}function vn(e){return e instanceof Error?e:new Error(typeof e=="string"?e:"Unknown error",{cause:e})}function ls(e,t=P){throw vn(e)}function Ct(e){if(typeof e=="function"&&!e.length)return Ct(e());if(Array.isArray(e)){const t=[];for(let s=0;s<e.length;s++){const n=Ct(e[s]);Array.isArray(n)?t.push.apply(t,n):t.push(n)}return t}return e}function Tn(e,t){return function(n){let i;return K(()=>i=ce(()=>(P.context={...P.context,[e]:n.value},mn(()=>n.children))),void 0),i}}const yn=Symbol("fallback");function cs(e){for(let t=0;t<e.length;t++)e[t]()}function wn(e,t,s={}){let n=[],i=[],r=[],a=0,o=t.length>1?[]:null;return Me(()=>cs(r)),()=>{let l=e()||[],c=l.length,u,h;return l[Bt],ce(()=>{let d,m,p,E,T,y,k,w,_;if(c===0)a!==0&&(cs(r),r=[],n=[],i=[],a=0,o&&(o=[])),s.fallback&&(n=[yn],i[0]=Qe(C=>(r[0]=C,s.fallback())),a=1);else if(a===0){for(i=new Array(c),h=0;h<c;h++)n[h]=l[h],i[h]=Qe(g);a=c}else{for(p=new Array(c),E=new Array(c),o&&(T=new Array(c)),y=0,k=Math.min(a,c);y<k&&n[y]===l[y];y++);for(k=a-1,w=c-1;k>=y&&w>=y&&n[k]===l[w];k--,w--)p[w]=i[k],E[w]=r[k],o&&(T[w]=o[k]);for(d=new Map,m=new Array(w+1),h=w;h>=y;h--)_=l[h],u=d.get(_),m[h]=u===void 0?-1:u,d.set(_,h);for(u=y;u<=k;u++)_=n[u],h=d.get(_),h!==void 0&&h!==-1?(p[h]=i[u],E[h]=r[u],o&&(T[h]=o[u]),h=m[h],d.set(_,h)):r[u]();for(h=y;h<c;h++)h in p?(i[h]=p[h],r[h]=E[h],o&&(o[h]=T[h],o[h](h))):i[h]=Qe(g);i=i.slice(0,a=c),n=l.slice(0)}return i});function g(d){if(r[h]=d,o){const[m,p]=V(h);return o[h]=p,t(l[h],m)}return t(l[h])}}}function S(e,t){return ce(()=>e(t||{}))}const kn=e=>`Stale read from <${e}>.`;function bn(e){const t="fallback"in e&&{fallback:()=>e.fallback};return se(wn(()=>e.each,e.children,t||void 0))}function us(e){const t=e.keyed,s=se(()=>e.when,void 0,void 0),n=t?s:se(s,void 0,{equals:(i,r)=>!i==!r});return se(()=>{const i=n();if(i){const r=e.children;return typeof r=="function"&&r.length>0?ce(()=>r(t?i:()=>{if(!ce(n))throw kn("Show");return s()})):r}return e.fallback},void 0,void 0)}function xn(e,t,s){let n=s.length,i=t.length,r=n,a=0,o=0,l=t[i-1].nextSibling,c=null;for(;a<i||o<r;){if(t[a]===s[o]){a++,o++;continue}for(;t[i-1]===s[r-1];)i--,r--;if(i===a){const u=r<n?o?s[o-1].nextSibling:s[r-o]:l;for(;o<r;)e.insertBefore(s[o++],u)}else if(r===o)for(;a<i;)(!c||!c.has(t[a]))&&t[a].remove(),a++;else if(t[a]===s[r-1]&&s[o]===t[i-1]){const u=t[--i].nextSibling;e.insertBefore(s[o++],t[a++].nextSibling),e.insertBefore(s[--r],u),t[i]=s[r]}else{if(!c){c=new Map;let h=o;for(;h<r;)c.set(s[h],h++)}const u=c.get(t[a]);if(u!=null)if(o<u&&u<r){let h=a,g=1,d;for(;++h<i&&h<r&&!((d=c.get(t[h]))==null||d!==u+g);)g++;if(g>u-o){const m=t[a];for(;o<u;)e.insertBefore(s[o++],m)}else e.replaceChild(s[o++],t[a++])}else a++;else t[a++].remove()}}}const hs="_$DX_DELEGATE";function An(e,t,s,n={}){let i;return Qe(r=>{i=r,t===document?e():L(t,e(),t.firstChild?null:void 0,s)},n.owner),()=>{i(),t.textContent=""}}function N(e,t,s,n){let i;const r=()=>{const o=document.createElement("template");return o.innerHTML=e,o.content.firstChild},a=()=>(i||(i=r())).cloneNode(!0);return a.cloneNode=a,a}function ne(e,t=window.document){const s=t[hs]||(t[hs]=new Set);for(let n=0,i=e.length;n<i;n++){const r=e[n];s.has(r)||(s.add(r),t.addEventListener(r,In))}}function fs(e,t){t==null?e.removeAttribute("class"):e.className=t}function Mn(e,t,s){return ce(()=>e(t,s))}function L(e,t,s,n){if(s!==void 0&&!n&&(n=[]),typeof t!="function")return st(e,t,n,s);K(i=>st(e,t(),i,s),n)}function In(e){let t=e.target;const s=`$$${e.type}`,n=e.target,i=e.currentTarget,r=l=>Object.defineProperty(e,"target",{configurable:!0,value:l}),a=()=>{const l=t[s];if(l&&!t.disabled){const c=t[`${s}Data`];if(c!==void 0?l.call(t,c,e):l.call(t,e),e.cancelBubble)return}return t.host&&typeof t.host!="string"&&!t.host._$host&&t.contains(e.target)&&r(t.host),!0},o=()=>{for(;a()&&(t=t._$host||t.parentNode||t.host););};if(Object.defineProperty(e,"currentTarget",{configurable:!0,get(){return t||document}}),e.composedPath){const l=e.composedPath();r(l[0]);for(let c=0;c<l.length-2&&(t=l[c],!!a());c++){if(t._$host){t=t._$host,o();break}if(t.parentNode===i)break}}else o();r(n)}function st(e,t,s,n,i){for(;typeof s=="function";)s=s();if(t===s)return s;const r=typeof t,a=n!==void 0;if(e=a&&s[0]&&s[0].parentNode||e,r==="string"||r==="number"){if(r==="number"&&(t=t.toString(),t===s))return s;if(a){let o=s[0];o&&o.nodeType===3?o.data!==t&&(o.data=t):o=document.createTextNode(t),s=_e(e,s,n,o)}else s!==""&&typeof s=="string"?s=e.firstChild.data=t:s=e.textContent=t}else if(t==null||r==="boolean")s=_e(e,s,n);else{if(r==="function")return K(()=>{let o=t();for(;typeof o=="function";)o=o();s=st(e,o,s,n)}),()=>s;if(Array.isArray(t)){const o=[],l=s&&Array.isArray(s);if($t(o,t,s,i))return K(()=>s=st(e,o,s,n,!0)),()=>s;if(o.length===0){if(s=_e(e,s,n),a)return s}else l?s.length===0?ds(e,o,n):xn(e,s,o):(s&&_e(e),ds(e,o));s=o}else if(t.nodeType){if(Array.isArray(s)){if(a)return s=_e(e,s,n,t);_e(e,s,null,t)}else s==null||s===""||!e.firstChild?e.appendChild(t):e.replaceChild(t,e.firstChild);s=t}}return s}function $t(e,t,s,n){let i=!1;for(let r=0,a=t.length;r<a;r++){let o=t[r],l=s&&s[e.length],c;if(!(o==null||o===!0||o===!1))if((c=typeof o)=="object"&&o.nodeType)e.push(o);else if(Array.isArray(o))i=$t(e,o,l)||i;else if(c==="function")if(n){for(;typeof o=="function";)o=o();i=$t(e,Array.isArray(o)?o:[o],Array.isArray(l)?l:[l])||i}else e.push(o),i=!0;else{const u=String(o);l&&l.nodeType===3&&l.data===u?e.push(l):e.push(document.createTextNode(u))}}return i}function ds(e,t,s=null){for(let n=0,i=t.length;n<i;n++)e.insertBefore(t[n],s)}function _e(e,t,s,n){if(s===void 0)return e.textContent="";const i=n||document.createTextNode("");if(t.length){let r=!1;for(let a=t.length-1;a>=0;a--){const o=t[a];if(i!==o){const l=o.parentNode===e;!r&&!a?l?e.replaceChild(i,o):e.insertBefore(i,s):l&&o.remove()}else r=!0}}else e.insertBefore(i,s);return[i]}const Gt=Symbol("store-raw"),Re=Symbol("store-node"),ue=Symbol("store-has"),ms=Symbol("store-self");function gs(e){let t=e[we];if(!t&&(Object.defineProperty(e,we,{value:t=new Proxy(e,Ln)}),!Array.isArray(e))){const s=Object.keys(e),n=Object.getOwnPropertyDescriptors(e);for(let i=0,r=s.length;i<r;i++){const a=s[i];n[a].get&&Object.defineProperty(e,a,{enumerable:n[a].enumerable,get:n[a].get.bind(t)})}}return t}function nt(e){let t;return e!=null&&typeof e=="object"&&(e[we]||!(t=Object.getPrototypeOf(e))||t===Object.prototype||Array.isArray(e))}function Fe(e,t=new Set){let s,n,i,r;if(s=e!=null&&e[Gt])return s;if(!nt(e)||t.has(e))return e;if(Array.isArray(e)){Object.isFrozen(e)?e=e.slice(0):t.add(e);for(let a=0,o=e.length;a<o;a++)i=e[a],(n=Fe(i,t))!==i&&(e[a]=n)}else{Object.isFrozen(e)?e=Object.assign({},e):t.add(e);const a=Object.keys(e),o=Object.getOwnPropertyDescriptors(e);for(let l=0,c=a.length;l<c;l++)r=a[l],!o[r].get&&(i=e[r],(n=Fe(i,t))!==i&&(e[r]=n))}return e}function it(e,t){let s=e[t];return s||Object.defineProperty(e,t,{value:s=Object.create(null)}),s}function Ce(e,t,s){if(e[t])return e[t];const[n,i]=V(s,{equals:!1,internal:!0});return n.$=i,e[t]=n}function _n(e,t){const s=Reflect.getOwnPropertyDescriptor(e,t);return!s||s.get||!s.configurable||t===we||t===Re||(delete s.value,delete s.writable,s.get=()=>e[we][t]),s}function ps(e){Ut()&&Ce(it(e,Re),ms)()}function Rn(e){return ps(e),Reflect.ownKeys(e)}const Ln={get(e,t,s){if(t===Gt)return e;if(t===we)return s;if(t===Bt)return ps(e),s;const n=it(e,Re),i=n[t];let r=i?i():e[t];if(t===Re||t===ue||t==="__proto__")return r;if(!i){const a=Object.getOwnPropertyDescriptor(e,t);Ut()&&(typeof r!="function"||e.hasOwnProperty(t))&&!(a&&a.get)&&(r=Ce(n,t,r)())}return nt(r)?gs(r):r},has(e,t){return t===Gt||t===we||t===Bt||t===Re||t===ue||t==="__proto__"?!0:(Ut()&&Ce(it(e,ue),t)(),t in e)},set(){return!0},deleteProperty(){return!0},ownKeys:Rn,getOwnPropertyDescriptor:_n};function rt(e,t,s,n=!1){if(!n&&e[t]===s)return;const i=e[t],r=e.length;s===void 0?(delete e[t],e[ue]&&e[ue][t]&&i!==void 0&&e[ue][t].$()):(e[t]=s,e[ue]&&e[ue][t]&&i===void 0&&e[ue][t].$());let a=it(e,Re),o;if((o=Ce(a,t,i))&&o.$(()=>s),Array.isArray(e)&&e.length!==r){for(let l=e.length;l<r;l++)(o=a[l])&&o.$();(o=Ce(a,"length",r))&&o.$(e.length)}(o=a[ms])&&o.$()}function Es(e,t){const s=Object.keys(t);for(let n=0;n<s.length;n+=1){const i=s[n];rt(e,i,t[i])}}function Pn(e,t){if(typeof t=="function"&&(t=t(e)),t=Fe(t),Array.isArray(t)){if(e===t)return;let s=0,n=t.length;for(;s<n;s++){const i=t[s];e[s]!==i&&rt(e,s,i)}rt(e,"length",n)}else Es(e,t)}function $e(e,t,s=[]){let n,i=e;if(t.length>1){n=t.shift();const a=typeof n,o=Array.isArray(e);if(Array.isArray(n)){for(let l=0;l<n.length;l++)$e(e,[n[l]].concat(t),s);return}else if(o&&a==="function"){for(let l=0;l<e.length;l++)n(e[l],l)&&$e(e,[l].concat(t),s);return}else if(o&&a==="object"){const{from:l=0,to:c=e.length-1,by:u=1}=n;for(let h=l;h<=c;h+=u)$e(e,[h].concat(t),s);return}else if(t.length>1){$e(e[n],t,[n].concat(s));return}i=e[n],s=[n].concat(s)}let r=t[0];typeof r=="function"&&(r=r(i,s),r===i)||n===void 0&&r==null||(r=Fe(r),n===void 0||nt(i)&&nt(r)&&!Array.isArray(r)?Es(i,r):rt(e,n,r))}function Ht(...[e,t]){const s=Fe(e||{}),n=Array.isArray(s),i=gs(s);function r(...a){hn(()=>{n&&a.length===1?Pn(s,a[0]):$e(s,a)})}return[i,r]}var Sn=N('<div class=hlv-loading><div class=hlv-loading-spinner><svg xmlns=http://www.w3.org/2000/svg x=0px y=0px width=80px height=80px viewBox="0 0 80 80"><title>Loading</title><path fill=#ffffff d=M40,72C22.4,72,8,57.6,8,40C8,22.4,22.4,8,40,8c17.6,0,32,14.4,32,32c0,1.1-0.9,2-2,2s-2-0.9-2-2c0-15.4-12.6-28-28-28S12,24.6,12,40s12.6,28,28,28c1.1,0,2,0.9,2,2S41.1,72,40,72z></path></svg></div><div class=hlv-loading-log>'),Nn=N("<div class=hlv-loading-log-item>");const On={replay:"Replay",bsp:"Map",sound:"Sounds",sky:"Skybox",sprite:"Sprites",wad:"Wads"};function Bn(e){const[t,s]=Ht({});Be(()=>{const a=e.game.loader.events,o=a.on("loadstart",n),l=a.on("progress",i);Me(()=>{o==null||o(),l==null||l()})});const n=a=>{const o=t[a.type]?t[a.type]:[];for(let l=0;l<o.length;++l)if(o[l]===a)return;o.push({name:a.name,progress:0}),s(a.type,o)},i=a=>{if(!t[a.type])return;const o=t[a.type];for(let l=0;l<o.length;++l)if(o[l].name===a.name){s(a.type,l,{progress:a.progress});break}},r=(a,o)=>{let l=a;l=On[l];const c=`${Math.round(o*100)}%`;let u=29-l.length-c.length;u<2&&(u=9-c.length);const h=Array(u).join(".");return`${l}${h}${c}`};return(()=>{var a=Sn(),o=a.firstChild,l=o.nextSibling;return L(l,S(bn,{get each(){return Object.entries(t)},children:([c,u])=>(()=>{var h=Nn();return L(h,()=>r(c,u.reduce((g,d)=>g+d.progress,0)/u.length)),h})()})),K(()=>a.classList.toggle("visible",!!e.visible)),a})()}var Dn=N('<div class=hlv-settings><button type=button class=hlv-button><svg xmlns=http://www.w3.org/2000/svg width=24 height=24 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round><title>Toggle</title><path stroke=none d="M0 0h24v24H0z"fill=none></path><path d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c1 .608 2.296 .07 2.572 -1.065z"></path><path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"></path></svg></button><div class=hlv-settings-menu><span class=hlv-settings-menu-title>Mode</span><button type=button class=hlv-settings-menu-item>Free Move</button><span class=hlv-settings-menu-title>Display</span><button type=button class=hlv-settings-menu-item>Show keys'),Un=N("<button type=button class=hlv-settings-menu-item>Replay"),Fn=N("<span>");function vs(e){const[t,s]=V(!1),n=!!e.game.player.replay,i=()=>{e.game.mode!==j.FREE&&(e.game.changeMode(j.FREE),e.game.player.pause())},r=()=>{e.game.mode!==j.REPLAY&&e.game.changeMode(j.REPLAY)},a=()=>{e.game.changeShowKeys()};return(()=>{var o=Dn(),l=o.firstChild,c=l.nextSibling,u=c.firstChild,h=u.nextSibling,g=h.nextSibling,d=g.nextSibling;return l.$$click=()=>s(!t()),L(c,n?(()=>{var m=Un();return m.$$click=()=>r(),K(()=>m.classList.toggle("selected",e.game.mode===j.REPLAY)),m})():Fn(),h),h.$$click=()=>i(),d.$$click=()=>a(),K(m=>{var p=!!t(),E=e.game.mode===j.FREE,T=!!e.game.showKeys;return p!==m.e&&o.classList.toggle("open",m.e=p),E!==m.t&&h.classList.toggle("selected",m.t=E),T!==m.a&&d.classList.toggle("selected",m.a=T),m},{e:void 0,t:void 0,a:void 0}),o})()}ne(["click"]);const he=[{enabled:"fullscreenEnabled",element:"fullscreenElement",request:"requestFullscreen",exit:"exitFullscreen",change:"fullscreenchange",error:"fullscreenerror"},{enabled:"mozFullScreenEnabled",element:"mozFullScreenElement",request:"mozRequestFullScreen",exit:"mozCancelFullScreen",change:"mozfullscreenchange",error:"mozfullscreenerror"},{enabled:"webkitFullscreenEnabled",element:"webkitCurrentFullScreenElement",request:"webkitRequestFullscreen",exit:"webkitExitFullscreen",change:"webkitfullscreenchange",error:"webkitfullscreenerror"},{enabled:"msFullscreenEnabled",element:"msFullscreenElement",request:"msRequestFullscreen",exit:"msExitFullscreen",change:"MSFullscreenChange",error:"MSFullscreenError"}];let Ee=0;const ot=document;for(let e=0;e<he.length;++e)if(typeof ot[he[e].enabled]<"u"){Ee=e;break}const z={element(){return ot[he[Ee].element]},enabled(){return ot[he[Ee].enabled]},isInFullscreen(){return z.element()!==null},enter(e){e[he[Ee].request]()},exit(){ot[he[Ee].exit]()},onChange(e){return window.addEventListener(he[Ee].change,e)},onChangeRemove(e){window.removeEventListener(he[Ee].change,e)},onError(e){return window.addEventListener(he[Ee].error,e)}};var Cn=N('<button type=button class="hlv-button hlv-fullscreen-button">'),$n=N('<svg xmlns=http://www.w3.org/2000/svg width=24 height=24 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round class="icon icon-tabler icons-tabler-outline icon-tabler-minimize"><title>Exit fullscreen</title><path stroke=none d="M0 0h24v24H0z"fill=none></path><path d="M15 19v-2a2 2 0 0 1 2 -2h2"></path><path d="M15 5v2a2 2 0 0 0 2 2h2"></path><path d="M5 15h2a2 2 0 0 1 2 2v2"></path><path d="M5 9h2a2 2 0 0 0 2 -2v-2">'),Gn=N('<svg xmlns=http://www.w3.org/2000/svg width=24 height=24 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round><title>Fullscreen</title><path stroke=none d="M0 0h24v24H0z"fill=none></path><path d="M4 8v-2a2 2 0 0 1 2 -2h2"></path><path d="M4 16v2a2 2 0 0 0 2 2h2"></path><path d="M16 4h2a2 2 0 0 1 2 2v2"></path><path d="M16 20h2a2 2 0 0 0 2 -2v-2">');function Ts(e){const[t,s]=V(z.isInFullscreen());Be(()=>{z.onChange(i)}),Me(()=>{z.onChangeRemove(i)});const n=()=>{z.isInFullscreen()?z.exit():z.enter(e.root)},i=()=>{s(z.isInFullscreen())};return(()=>{var r=Cn();return r.$$click=()=>n(),L(r,(()=>{var a=se(()=>!!t());return()=>a()?$n():Gn()})()),r})()}ne(["click"]);var Hn=N("<div><div class=hlv-buttons><div class=hlv-buttons-left></div><div class=hlv-buttons-right>");function Xn(e){return(()=>{var t=Hn(),s=t.firstChild,n=s.firstChild,i=n.nextSibling;return L(i,S(vs,{get game(){return e.game}}),null),L(i,S(Ts,{active:!1,get root(){return e.root}}),null),K(()=>fs(t,e.class)),t})()}const ys=fn({mode:j.FREE,time:0,volume:1,isPlaying:!1,isPaused:!1});function at(){return dn(ys)}var Wn=N("<div class=hlv-time> / ");function jn(e){const t=at(),s=()=>pt(t.time),n=()=>pt(e.player.replay.length);return(()=>{var i=Wn(),r=i.firstChild;return L(i,s,r),L(i,n,null),i})()}var zn=N("<button type=button class=hlv-timeline><div class=hlv-timeline-ghostline></div><div class=hlv-timeline-line></div><div class=hlv-timeline-knob></div><div class=hlv-timeline-ghosttime>");function qn(e){const[t,s]=V(0),[n,i]=V(!1),[r,a]=V("0%"),[o,l]=V(0);Be(()=>{const p=e.game.events.on("postupdate",()=>{s(e.game.player.currentTime/e.game.player.replay.length)});Me(()=>{p==null||p()})});const c=p=>{const E=p.currentTarget.getClientRects()[0],T=1-(E.right-p.pageX)/(E.right-E.left);e.game.player.seekByPercent(T*100),e.game.player.pause();const y=k=>{const w=Math.max(0,Math.min(1-(E.right-k.pageX)/(E.right-E.left),1));e.game.player.seekByPercent(w*100),e.game.player.pause()};window.addEventListener("mousemove",y),window.addEventListener("mouseup",()=>{window.removeEventListener("mousemove",y)},{once:!0})},u=p=>{const E=p.currentTarget.getClientRects()[0],T=Math.max(0,Math.min(1-(E.right-p.pageX)/(E.right-E.left),1));n()&&(a(`${T*100}%`),l(e.game.player.replay.length*T))},h=()=>{i(!0)},g=()=>{i(!1)},d=()=>`${t()*100}%`,m=()=>`${100-t()*100}%`;return(()=>{var p=zn(),E=p.firstChild,T=E.nextSibling,y=T.nextSibling,k=y.nextSibling;return p.addEventListener("mouseleave",()=>g()),p.addEventListener("mouseenter",()=>h()),p.$$mousemove=w=>u(w),p.$$mousedown=w=>c(w),L(k,()=>pt(o())),K(w=>{var _=m(),C=d(),M=r();return _!==w.e&&((w.e=_)!=null?T.style.setProperty("right",_):T.style.removeProperty("right")),C!==w.t&&((w.t=C)!=null?y.style.setProperty("left",C):y.style.removeProperty("left")),M!==w.a&&((w.a=M)!=null?k.style.setProperty("left",M):k.style.removeProperty("left")),w},{e:void 0,t:void 0,a:void 0}),p})()}ne(["mousedown","mousemove"]);var Vn=N("<div class=hlv-volume><div class=hlv-volume-ghostline></div><div class=hlv-volume-line></div><div class=hlv-volume-knob>");function Kn(e){const t=at(),s=a=>{const o=a.currentTarget.getClientRects()[0],l=1-(o.right-a.pageX)/(o.right-o.left);e.game.soundSystem.setVolume(l);const c=u=>{const h=Math.max(0,Math.min(1-(o.right-u.pageX)/(o.right-o.left),1));e.game.soundSystem.setVolume(h)};window.addEventListener("mousemove",c),window.addEventListener("mouseup",()=>{window.removeEventListener("mousemove",c)},{once:!0})},n=()=>t.volume*100,i=()=>`${Math.min(95,Math.max(5,n()))}%`,r=()=>`${Math.min(95,Math.max(5,100-n()))}%`;return(()=>{var a=Vn(),o=a.firstChild,l=o.nextSibling,c=l.nextSibling;return a.$$mousedown=u=>s(u),K(u=>{var h=r(),g=i();return h!==u.e&&((u.e=h)!=null?l.style.setProperty("right",h):l.style.removeProperty("right")),g!==u.t&&((u.t=g)!=null?c.style.setProperty("left",g):c.style.removeProperty("left")),u},{e:void 0,t:void 0}),a})()}ne(["mousedown"]);var Zn=N('<button type=button class=hlv-button><svg xmlns=http://www.w3.org/2000/svg width=24 height=24 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round><title>Play</title><path stroke=none d="M0 0h24v24H0z"fill=none></path><path d="M7 4v16l13 -8z">');function Yn(e){return(()=>{var t=Zn();return t.$$click=()=>e.onClick(),t})()}ne(["click"]);var Jn=N('<button type=button class=hlv-button><svg xmlns=http://www.w3.org/2000/svg width=24 height=24 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round><title>Pause</title><path stroke=none d="M0 0h24v24H0z"fill=none></path><path d="M6 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z"></path><path d="M14 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z">');function Qn(e){return(()=>{var t=Jn();return t.$$click=()=>e.onClick(),t})()}ne(["click"]);var ei=N('<svg xmlns=http://www.w3.org/2000/svg width=24 height=24 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round><title>Volume Full</title><path stroke=none d="M0 0h24v24H0z"fill=none></path><path d="M15 8a5 5 0 0 1 0 8"></path><path d="M17.7 5a9 9 0 0 1 0 14"></path><path d="M6 15h-2a1 1 0 0 1 -1 -1v-4a1 1 0 0 1 1 -1h2l3.5 -4.5a.8 .8 0 0 1 1.5 .5v14a.8 .8 0 0 1 -1.5 .5l-3.5 -4.5">');function ti(){return ei()}var si=N('<svg xmlns=http://www.w3.org/2000/svg width=24 height=24 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round class="icon icon-tabler icons-tabler-outline icon-tabler-volume-2"><title>Volume Half</title><path stroke=none d="M0 0h24v24H0z"fill=none></path><path d="M15 8a5 5 0 0 1 0 8"></path><path d="M6 15h-2a1 1 0 0 1 -1 -1v-4a1 1 0 0 1 1 -1h2l3.5 -4.5a.8 .8 0 0 1 1.5 .5v14a.8 .8 0 0 1 -1.5 .5l-3.5 -4.5">');function ni(){return si()}var ii=N('<svg xmlns=http://www.w3.org/2000/svg width=24 height=24 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round class="icon icon-tabler icons-tabler-outline icon-tabler-volume-3"><title>Volume Mute</title><path stroke=none d="M0 0h24v24H0z"fill=none></path><path d="M6 15h-2a1 1 0 0 1 -1 -1v-4a1 1 0 0 1 1 -1h2l3.5 -4.5a.8 .8 0 0 1 1.5 .5v14a.8 .8 0 0 1 -1.5 .5l-3.5 -4.5"></path><path d="M16 10l4 4m0 -4l-4 4">');function ri(){return ii()}var oi=N("<button type=button class=hlv-button>");function ai(e){const t=at();return(()=>{var s=oi();return s.$$click=()=>e.onClick(),L(s,(()=>{var n=se(()=>t.volume===0);return()=>n()?S(ri,{}):se(()=>t.volume>.5)()?S(ti,{}):S(ni,{})})()),s})()}ne(["click"]);var li=N('<button type=button class=hlv-button><svg xmlns=http://www.w3.org/2000/svg width=24 height=24 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round><title>Speed Up</title><path stroke=none d="M0 0h24v24H0z"fill=none></path><path d="M3 5v14l8 -7z"></path><path d="M14 5v14l8 -7z">');function ci(e){return(()=>{var t=li();return t.$$click=()=>e.onClick(),t})()}ne(["click"]);var ui=N('<button type=button class=hlv-button><svg xmlns=http://www.w3.org/2000/svg width=24 height=24 viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round><title>Speed Down</title><path stroke=none d="M0 0h24v24H0z"fill=none></path><path d="M21 5v14l-8 -7z"></path><path d="M10 5v14l-8 -7z">');function hi(e){return(()=>{var t=ui();return t.$$click=()=>e.onClick(),t})()}ne(["click"]);var fi=N("<div><div class=hlv-buttons><div class=hlv-buttons-left><div></div><div></div></div><div class=hlv-buttons-right>");function di(e){const t=at(),s=()=>{e.game.player.play()},n=()=>{e.game.player.pause()},i=()=>{e.game.player.speedDown()},r=()=>{e.game.player.speedUp()},a=()=>{e.game.soundSystem.toggleMute()};return(()=>{var o=fi(),l=o.firstChild,c=l.firstChild,u=c.firstChild;u.nextSibling;var h=c.nextSibling;return L(o,S(qn,{get game(){return e.game}}),l),L(c,S(hi,{onClick:()=>i()}),u),L(c,(()=>{var g=se(()=>!!(t.isPaused||!t.isPlaying));return()=>g()?S(Yn,{onClick:()=>s()}):S(Qn,{onClick:()=>n()})})(),u),L(c,S(ci,{onClick:()=>r()}),u),L(c,S(ai,{onClick:()=>a()}),null),L(c,S(Kn,{get game(){return e.game}}),null),L(c,S(jn,{get player(){return e.game.player}}),null),L(h,S(vs,{get game(){return e.game}}),null),L(h,S(Ts,{active:!0,get root(){return e.root}}),null),K(()=>fs(o,e.class)),o})()}var mi=N('<div class=hlv-keys-hud><div class=hlv-keyboard><div class="hlv-key hlv-key-w">W</div><div class="hlv-key hlv-key-a">A</div><div class="hlv-key hlv-key-s">S</div><div class="hlv-key hlv-key-d">D</div><div class="hlv-key hlv-key-duck">DUCK</div><div class="hlv-key hlv-key-jump">JUMP</div><div class="hlv-key hlv-key-use">USE');function gi(e){const[t,s]=Ht({jump:!1,duck:!1,forward:!1,back:!1,use:!1,moveleft:!1,moveright:!1});Be(()=>{const r=e.game.player.events.on("keyspressed",n);Me(()=>{r==null||r()})});const n=i=>{s("jump",(i&W.BTN_JUMP)!=0),s("duck",(i&W.BTN_DUCK)!=0),s("use",(i&W.BTN_USE)!=0);const r=(i&W.BTN_FORWARD)!=0,a=(i&W.BTN_BACK)!=0,o=(i&W.BTN_MOVELEFT)!=0,l=(i&W.BTN_MOVERIGHT)!=0;s("forward",r&&!a),s("back",a&&!r),s("moveleft",o&&!l),s("moveright",l&&!o)};return(()=>{var i=mi(),r=i.firstChild,a=r.firstChild,o=a.nextSibling,l=o.nextSibling,c=l.nextSibling,u=c.nextSibling,h=u.nextSibling,g=h.nextSibling;return K(d=>{var m=!!e.visible,p=!!t.forward,E=!!t.moveleft,T=!!t.back,y=!!t.moveright,k=!!t.duck,w=!!t.jump,_=!!t.use;return m!==d.e&&i.classList.toggle("visible",d.e=m),p!==d.t&&a.classList.toggle("activated",d.t=p),E!==d.a&&o.classList.toggle("activated",d.a=E),T!==d.o&&l.classList.toggle("activated",d.o=T),y!==d.i&&c.classList.toggle("activated",d.i=y),k!==d.n&&u.classList.toggle("activated",d.n=k),w!==d.s&&h.classList.toggle("activated",d.s=w),_!==d.h&&g.classList.toggle("activated",d.h=_),d},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),i})()}var pi=N("<div class=hlv-app><div class=hlv-title></div><button type=button class=hlv-screen>");function Ei(e){let t=null,s;const[n,i]=V(e.game.title),[r,a]=V(!1),[o,l]=V(!1),[c,u]=V(!1),[h,g]=V(!1),[d,m]=Ht({mode:e.game.mode,time:e.game.player.currentTime,volume:e.game.soundSystem.getVolume(),isPlaying:e.game.player.isPlaying,isPaused:e.game.player.isPaused,showKeys:e.game.showKeys});Be(()=>{if(!t)return;const A=e.game,F=e.root;t.appendChild(A.getCanvas());const q=A.events.on("loadstart",()=>l(!0)),$=A.events.on("load",()=>l(!1)),I=A.events.on("modechange",Te=>m({mode:Te})),U=A.events.on("titlechange",Te=>i(Te)),ee=e.game.player.events.on("play",()=>m({isPlaying:!0,isPaused:!1})),lt=e.game.player.events.on("pause",()=>m({isPlaying:!0,isPaused:!0})),ct=e.game.player.events.on("stop",()=>m({isPlaying:!1,isPaused:!1})),ut=e.game.soundSystem.events.on("volumeChange",()=>{m({volume:e.game.soundSystem.getVolume()})}),ht=A.events.on("showkeyschange",Te=>m({showKeys:Te}));let Xt;const ks=()=>{Xt=setInterval(()=>{m({time:e.game.player.currentTime})},100)},Wt=()=>{clearInterval(Xt)},ft=e.game.player.events.on("play",ks),dt=e.game.player.events.on("pause",Wt),mt=e.game.player.events.on("stop",Wt),gt=e.game.player.events.on("seek",Te=>m({time:Te}));window.addEventListener("click",T),window.addEventListener("keydown",k),document.addEventListener("pointerlockchange",p,!1),F.addEventListener("click",y),F.addEventListener("mouseover",w),F.addEventListener("mousemove",_),F.addEventListener("mouseout",C),F.addEventListener("contextmenu",E),Me(()=>{q==null||q(),$==null||$(),I==null||I(),U==null||U(),ee==null||ee(),lt==null||lt(),ct==null||ct(),ut==null||ut(),ht==null||ht(),ft==null||ft(),dt==null||dt(),mt==null||mt(),gt==null||gt(),e.root.removeEventListener("click",y),window.removeEventListener("click",T),window.removeEventListener("keydown",k),document.removeEventListener("pointerlockchange",p,!1),e.root.removeEventListener("mouseover",w),e.root.removeEventListener("mousemove",_),e.root.removeEventListener("mouseout",C),e.root.removeEventListener("contextmenu",E)})});const p=()=>{document.pointerLockElement===e.root?e.game.pointerLocked=!0:e.game.pointerLocked=!1},E=A=>{A.preventDefault()},T=A=>{A.target.closest(".hlv-app")||a(!1)},y=()=>{a(!0),M()},k=A=>{if(r())switch(A.code){case"KeyF":{z.isInFullscreen()?z.exit():z.enter(e.root),M();break}case"KeyM":{e.game.soundSystem.toggleMute(),M();break}case"ArrowUp":{e.game.soundSystem.setVolume(e.game.soundSystem.getVolume()+.05),M();break}case"ArrowDown":{e.game.soundSystem.setVolume(e.game.soundSystem.getVolume()-.05),M();break}case"KeyJ":case"ArrowLeft":{e.game.player.seek(e.game.player.currentTime-5),M();break}case"KeyL":case"ArrowRight":{e.game.player.seek(e.game.player.currentTime+5),M();break}case"KeyK":case"Space":{if(d.mode!==j.REPLAY)return;!e.game.player.isPlaying||e.game.player.isPaused?e.game.player.play():e.game.player.pause();break}}},w=()=>{u(!0),M()},_=()=>{c()&&!z.isInFullscreen()&&M()},C=()=>{u(!1),g(!1),clearTimeout(s),s=void 0},M=()=>{h()||g(!0),clearTimeout(s),s=setTimeout(()=>{g(!1),s=void 0},2e3)},b=()=>{switch(d.mode){case j.REPLAY:{const A=e.game.player;!A.isPlaying||A.isPaused?A.play():A.pause();break}case j.FREE:{e.root.requestPointerLock();break}}},x=()=>{z.isInFullscreen()?z.exit():z.enter(e.root)};return S(ys.Provider,{value:d,get children(){var A=pi(),F=A.firstChild,q=F.nextSibling;return L(F,n),L(A,S(Bn,{get game(){return e.game},get visible(){return o()}}),q),L(A,S(gi,{get game(){return e.game},get visible(){return d.showKeys&&d.isPlaying}}),q),q.$$dblclick=()=>x(),q.$$click=()=>b(),Mn($=>{t=$},q),L(A,S(us,{get when(){return d.mode===j.FREE},get children(){return S(Xn,{class:"hlv-controls",get game(){return e.game},get root(){return e.root}})}}),null),L(A,S(us,{get when(){return d.mode===j.REPLAY},get children(){return S(di,{class:"hlv-controls",get game(){return e.game},get root(){return e.root},get visible(){return c()}})}}),null),K($=>{var I=!!h(),U=d.mode===j.FREE,ee=d.mode===j.REPLAY;return I!==$.e&&A.classList.toggle("visible",$.e=I),U!==$.t&&A.classList.toggle("mode-free",$.t=U),ee!==$.a&&A.classList.toggle("mode-replay",$.a=ee),$},{e:void 0,t:void 0,a:void 0}),A}})}ne(["click","dblclick"]);class vi{constructor(t,s){f(this,"game");f(this,"rootNode");this.game=t,this.rootNode=s}getRootNode(){return this.rootNode}draw(){An(()=>{const t=this;return S(Ei,{get game(){return t.game},get root(){return t.rootNode}})},this.rootNode)}}class ws{constructor(t){f(this,"game");this.game=t}load(t){this.game.load(t)}setTitle(t){this.game.setTitle(t)}getTitle(){return this.game.getTitle()}}f(ws,"VERSION","0.8.3"),X.HLViewer=void 0,(e=>{function t(s,n){const i=document.querySelector(s);if(!i)return null;const r=Ke.init(n),a=Ot.init(r);if(a.status==="success"){const o=a.game;return new vi(o,i).draw(),o.draw(),new ws(o)}return null}e.init=t})(X.HLViewer||(X.HLViewer={})),typeof window<"u"&&Object.assign(window,{HLViewer:X.HLViewer}),Object.defineProperty(X,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=hlviewer.min.js.map
